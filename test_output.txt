============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Scripts\python.exe
cachedir: .pytest_cache
django: version: 5.2.3, settings: zenzspa.settings (from ini)
rootdir: C:\Users\joshe\Desktop\Zenz\zenzspa_project
configfile: pytest.ini
plugins: anyio-4.11.0, cov-7.0.0, django-4.11.1, mock-3.15.1
collecting ... collected 29 items

bot/tests/test_views.py::TestBotWebhook::test_anonymous_access_allowed FAILED [  3%]
bot/tests/test_views.py::TestBotWebhook::test_happy_path_mocking_gemini FAILED [  6%]
bot/tests/test_views.py::TestBotWebhook::test_security_block_response FAILED [ 10%]
bot/tests/test_views.py::TestBotWebhook::test_duplicate_request_deduplication FAILED [ 13%]
bot/tests/test_views.py::TestBotWebhook::test_blocked_user_access_denied PASSED [ 17%]
bot/tests/test_views.py::TestBotWebhook::test_input_length_validation PASSED [ 20%]
bot/tests/test_views.py::TestBotWebhook::test_empty_message_validation PASSED [ 24%]
bot/tests/test_views.py::TestBotWebhook::test_jailbreak_attempt_validation PASSED [ 27%]
bot/tests/test_views.py::TestBotWebhook::test_velocity_limit_exceeded PASSED [ 31%]
bot/tests/test_views.py::TestBotWebhook::test_repetition_limit_exceeded PASSED [ 34%]
bot/tests/test_views.py::TestBotWebhook::test_gemini_service_timeout FAILED [ 37%]
bot/tests/test_views.py::TestBotWebhook::test_concurrency_lock_failure PASSED [ 41%]
bot/tests/test_views.py::TestBotWebhook::test_invalid_message_type_returns_400 PASSED [ 44%]
bot/tests/test_views.py::TestBotWebhook::test_normalize_chat_response_breaks_long_lines PASSED [ 48%]
bot/tests/test_views.py::TestBotWebhook::test_get_client_ip_invalid_value PASSED [ 51%]
bot/tests/test_views.py::TestHealthCheck::test_health_check_endpoint PASSED [ 55%]
bot/tests/test_views.py::TestIPBlockEndpoints::test_block_ip_requires_reason PASSED [ 58%]
bot/tests/test_views.py::TestIPBlockEndpoints::test_block_ip_creates_entry PASSED [ 62%]
bot/tests/test_views.py::TestIPBlockEndpoints::test_block_ip_rejects_duplicates PASSED [ 65%]
bot/tests/test_views.py::TestIPBlockEndpoints::test_unblock_ip_success_and_not_found PASSED [ 68%]
bot/tests/test_views.py::TestTaskStatusView::test_task_status_success PASSED [ 72%]
bot/tests/test_views.py::TestTaskStatusView::test_task_status_pending PASSED [ 75%]
bot/tests/test_views.py::TestHumanHandoffViewSet::test_assign_and_resolve_flow PASSED [ 79%]
bot/tests/test_views.py::TestHumanHandoffViewSet::test_messages_mark_client_messages_as_read PASSED [ 82%]
bot/tests/test_views.py::TestHumanHandoffViewSet::test_send_message_moves_status_in_progress PASSED [ 86%]
bot/tests/test_views.py::TestAnalyticsAndSuspiciousViews::test_bot_analytics_view PASSED [ 89%]
bot/tests/test_views.py::TestAnalyticsAndSuspiciousViews::test_suspicious_users_view PASSED [ 93%]
bot/tests/test_views.py::TestAnalyticsAndSuspiciousViews::test_activity_timeline_requires_params PASSED [ 96%]
bot/tests/test_views.py::TestAnalyticsAndSuspiciousViews::test_activity_timeline_returns_block_info PASSED [100%]

================================== FAILURES ===================================
________________ TestBotWebhook.test_anonymous_access_allowed _________________
bot\tests\test_views.py:30: in test_anonymous_access_allowed
    response = api_client.post(self.url, {"message": "Hola"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:299: in post
    response = super().post(
venv\Lib\site-packages\rest_framework\test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:237: in generic
    return super().generic(
venv\Lib\site-packages\django\test\client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\test\client.py:1087: in request
    self.check_exception(response)
venv\Lib\site-packages\django\test\client.py:802: in check_exception
    raise exc_value
venv\Lib\site-packages\django\core\handlers\exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\core\handlers\base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\decorators\csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\generic\base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
venv\Lib\site-packages\rest_framework\views.py:486: in raise_uncaught_exception
    raise exc
venv\Lib\site-packages\rest_framework\views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
bot\views.py:368: in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
E   NameError: name 'settings' is not defined
---------------------------- Captured stderr setup ----------------------------
Using existing test database for alias 'default'...

---------------------------- Captured stderr call -----------------------------
[INFO] Nuevo usuario an¾nimo creado: 06e3feaf-5a6c-4a1e-92b5-8fead9a0b17a desde IP 127.0.0.1
[INFO] Usuario anon_423 (IP: 127.0.0.1): mensaje 1/30 del dÝa (IP: 1/50)
[ERROR] Request failed: POST /api/v1/bot/webhook/ - 0.06s - name 'settings' is not defined
[ERROR] Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call ------------------------------
ERROR    core.middleware:middleware.py:129 Request failed: POST /api/v1/bot/webhook/ - 0.06s - name 'settings' is not defined
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
________________ TestBotWebhook.test_happy_path_mocking_gemini ________________
bot\tests\test_views.py:54: in test_happy_path_mocking_gemini
    response = api_client.post(self.url, payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:299: in post
    response = super().post(
venv\Lib\site-packages\rest_framework\test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:237: in generic
    return super().generic(
venv\Lib\site-packages\django\test\client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\test\client.py:1087: in request
    self.check_exception(response)
venv\Lib\site-packages\django\test\client.py:802: in check_exception
    raise exc_value
venv\Lib\site-packages\django\core\handlers\exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\core\handlers\base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\decorators\csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\generic\base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
venv\Lib\site-packages\rest_framework\views.py:486: in raise_uncaught_exception
    raise exc
venv\Lib\site-packages\rest_framework\views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
bot\views.py:368: in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
E   NameError: name 'settings' is not defined
---------------------------- Captured stderr call -----------------------------
[INFO] Usuario e809bdc6-72f0-4a35-b116-2d18616ad213 (IP: 127.0.0.1): mensaje 1/30 del dÝa (IP: 1/50)
[ERROR] Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
[ERROR] Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call ------------------------------
ERROR    core.middleware:middleware.py:129 Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
_________________ TestBotWebhook.test_security_block_response _________________
bot\tests\test_views.py:87: in test_security_block_response
    response = api_client.post(self.url, {"message": "ExplÝcame fÝsica cußntica"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:299: in post
    response = super().post(
venv\Lib\site-packages\rest_framework\test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:237: in generic
    return super().generic(
venv\Lib\site-packages\django\test\client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\test\client.py:1087: in request
    self.check_exception(response)
venv\Lib\site-packages\django\test\client.py:802: in check_exception
    raise exc_value
venv\Lib\site-packages\django\core\handlers\exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\core\handlers\base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\decorators\csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\generic\base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
venv\Lib\site-packages\rest_framework\views.py:486: in raise_uncaught_exception
    raise exc
venv\Lib\site-packages\rest_framework\views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
bot\views.py:368: in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
E   NameError: name 'settings' is not defined
---------------------------- Captured stderr call -----------------------------
[INFO] Usuario c8c59c12-d3d0-4431-a764-f9ffec7907a0 (IP: 127.0.0.1): mensaje 1/30 del dÝa (IP: 1/50)
[ERROR] Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
[ERROR] Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call ------------------------------
ERROR    core.middleware:middleware.py:129 Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
_____________ TestBotWebhook.test_duplicate_request_deduplication _____________
bot\tests\test_views.py:113: in test_duplicate_request_deduplication
    api_client.post(self.url, {"message": "Hola"})
venv\Lib\site-packages\rest_framework\test.py:299: in post
    response = super().post(
venv\Lib\site-packages\rest_framework\test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:237: in generic
    return super().generic(
venv\Lib\site-packages\django\test\client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\test\client.py:1087: in request
    self.check_exception(response)
venv\Lib\site-packages\django\test\client.py:802: in check_exception
    raise exc_value
venv\Lib\site-packages\django\core\handlers\exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\core\handlers\base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\decorators\csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\generic\base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
venv\Lib\site-packages\rest_framework\views.py:486: in raise_uncaught_exception
    raise exc
venv\Lib\site-packages\rest_framework\views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
bot\views.py:368: in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
E   NameError: name 'settings' is not defined
---------------------------- Captured stderr call -----------------------------
[INFO] Usuario c15bcd2c-ac63-4608-b98e-cf5856e08875 (IP: 127.0.0.1): mensaje 1/30 del dÝa (IP: 1/50)
[ERROR] Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
[ERROR] Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call ------------------------------
ERROR    core.middleware:middleware.py:129 Request failed: POST /api/v1/bot/webhook/ - 0.01s - name 'settings' is not defined
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
_________________ TestBotWebhook.test_gemini_service_timeout __________________
bot\tests\test_views.py:232: in test_gemini_service_timeout
    response = api_client.post(self.url, {"message": "Hola"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:299: in post
    response = super().post(
venv\Lib\site-packages\rest_framework\test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:237: in generic
    return super().generic(
venv\Lib\site-packages\django\test\client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\test\client.py:1087: in request
    self.check_exception(response)
venv\Lib\site-packages\django\test\client.py:802: in check_exception
    raise exc_value
venv\Lib\site-packages\django\core\handlers\exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\core\handlers\base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\decorators\csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\views\generic\base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\rest_framework\views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
venv\Lib\site-packages\rest_framework\views.py:486: in raise_uncaught_exception
    raise exc
venv\Lib\site-packages\rest_framework\views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
bot\views.py:368: in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
E   NameError: name 'settings' is not defined
---------------------------- Captured stderr call -----------------------------
[INFO] Usuario 8804fe1e-f7f1-4aaf-b9ed-659e7ebf7281 (IP: 127.0.0.1): mensaje 1/30 del dÝa (IP: 1/50)
[ERROR] Request failed: POST /api/v1/bot/webhook/ - 0.00s - name 'settings' is not defined
[ERROR] Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call ------------------------------
ERROR    core.middleware:middleware.py:129 Request failed: POST /api/v1/bot/webhook/ - 0.00s - name 'settings' is not defined
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/bot/webhook/
Traceback (most recent call last):
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 486, in raise_uncaught_exception
    raise exc
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\joshe\Desktop\Zenz\zenzspa_project\bot\views.py", line 368, in post
    if getattr(settings, 'BOT_ASYNC_MODE', False):
               ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
=========================== short test summary info ===========================
FAILED bot/tests/test_views.py::TestBotWebhook::test_anonymous_access_allowed
FAILED bot/tests/test_views.py::TestBotWebhook::test_happy_path_mocking_gemini
FAILED bot/tests/test_views.py::TestBotWebhook::test_security_block_response
FAILED bot/tests/test_views.py::TestBotWebhook::test_duplicate_request_deduplication
FAILED bot/tests/test_views.py::TestBotWebhook::test_gemini_service_timeout
=================== 5 failed, 24 passed, 1 warning in 5.05s ===================
