============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\joshe\Desktop\Zenz\zenzspa_project\venv\Scripts\python.exe
cachedir: .pytest_cache
django: version: 5.2.3, settings: zenzspa.settings (from ini)
rootdir: C:\Users\joshe\Desktop\Zenz\zenzspa_project
configfile: pytest.ini
plugins: anyio-4.11.0, cov-7.0.0, django-4.11.1, mock-3.15.1
collecting ... collected 15 items

bot/tests/test_tasks.py::TestBotTasks::test_report_daily_token_usage PASSED [  6%]
bot/tests/test_tasks.py::TestBotTasks::test_cleanup_old_logs PASSED      [ 13%]
bot/tests/test_tasks.py::TestBotTasks::test_monitor_bot_health_no_activity PASSED [ 20%]
bot/tests/test_tasks.py::TestBotTasks::test_monitor_bot_health_normal PASSED [ 26%]
bot/tests/test_tasks.py::TestBotTasks::test_monitor_bot_health_high_block_rate PASSED [ 33%]
bot/tests/test_tasks.py::TestBotTasks::test_monitor_bot_health_high_latency PASSED [ 40%]
bot/tests/test_tasks.py::TestBotTasks::test_check_rate_limit_blocks_when_full PASSED [ 46%]
bot/tests/test_tasks.py::TestBotTasks::test_check_rate_limit_allows_when_empty PASSED [ 53%]
bot/tests/test_tasks.py::TestBotTasks::test_process_bot_message_async_rate_limited PASSED [ 60%]
bot/tests/test_tasks.py::TestBotTasks::test_process_bot_message_async_creates_log PASSED [ 66%]
bot/tests/test_tasks.py::TestBotTasks::test_process_bot_message_async_missing_user PASSED [ 73%]
bot/tests/test_tasks.py::TestBotTasks::test_process_bot_message_async_returns_error_after_retries FAILED [ 80%]
bot/tests/test_tasks.py::TestBotTasks::test_report_daily_token_usage_without_config PASSED [ 86%]
bot/tests/test_tasks.py::TestBotTasks::test_report_daily_token_usage_estimates_tokens PASSED [ 93%]
bot/tests/test_tasks.py::TestBotTasks::test_cleanup_expired_anonymous_users PASSED [100%]

================================== FAILURES ===================================
___ TestBotTasks.test_process_bot_message_async_returns_error_after_retries ___
bot\tests\test_tasks.py:278: in test_process_bot_message_async_returns_error_after_retries
    result = process_bot_message_async.run(
bot\tasks.py:271: in process_bot_message_async
    raise self.retry(countdown=10, exc=e)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\celery\app\task.py:727: in retry
    raise_with_context(exc or Retry('Task can be retried', None))
bot\tasks.py:146: in process_bot_message_async
    agent_response, meta = gemini.generate_response(prompt)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1228: in _execute_mock_call
    raise effect
E   ValueError: boom
---------------------------- Captured stderr call -----------------------------
[ERROR] \u274c Error procesando mensaje en task None: boom\nTraceback (most recent call last):\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\bot\\tasks.py", line 146, in process_bot_message_async\n    agent_response, meta = gemini.generate_response(prompt)\n                           ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1169, in __call__\n    return self._mock_call(*args, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1173, in _mock_call\n    return self._execute_mock_call(*args, **kwargs)\n           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1228, in _execute_mock_call\n    raise effect\nValueError: boom\n--- Logging error ---\nTraceback (most recent call last):\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\bot\\tasks.py", line 146, in process_bot_message_async\n    agent_response, meta = gemini.generate_response(prompt)\n                           ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1169, in __call__\n    return self._mock_call(*args, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1173, in _mock_call\n    return self._execute_mock_call(*args, **kwargs)\n           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\unittest\\mock.py", line 1228, in _execute_mock_call\n    raise effect\nValueError: boom\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\logging\\__init__.py", line 1153, in emit\n    stream.write(msg + self.terminator)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File "C:\\Users\\joshe\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\encodings\\cp1252.py", line 19, in encode\n    return codecs.charmap_encode(input,self.errors,encoding_table)[0]\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nUnicodeEncodeError: 'charmap' codec can't encode character '\\u274c' in position 55: character maps to <undefined>\nCall stack:\n  File "<frozen runpy>", line 198, in _run_module_as_main\n  File "<frozen runpy>", line 88, in _run_code\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pytest\\__main__.py", line 9, in <module>\n    raise SystemExit(pytest.console_main())\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\config\\__init__.py", line 221, in console_main\n    code = main()\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\config\\__init__.py", line 197, in main\n    ret: ExitCode | int = config.hook.pytest_cmdline_main(config=config)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_hooks.py", line 512, in __call__\n    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_manager.py", line 120, in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_callers.py", line 121, in _multicall\n    res = hook_impl.function(*args)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\main.py", line 365, in pytest_cmdline_main\n    return wrap_session(config, _main)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\main.py", line 318, in wrap_session\n    session.exitstatus = doit(config, session) or 0\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\main.py", line 372, in _main\n    config.hook.pytest_runtestloop(session=session)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_hooks.py", line 512, in __call__\n    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_manager.py", line 120, in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_callers.py", line 121, in _multicall\n    res = hook_impl.function(*args)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\main.py", line 396, in pytest_runtestloop\n    item.config.hook.pytest_runtest_protocol(item=item, nextitem=nextitem)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_hooks.py", line 512, in __call__\n    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_manager.py", line 120, in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_callers.py", line 121, in _multicall\n    res = hook_impl.function(*args)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 118, in pytest_runtest_protocol\n    runtestprotocol(item, nextitem=nextitem)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 137, in runtestprotocol\n    reports.append(call_and_report(item, "call", log))\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 244, in call_and_report\n    call = CallInfo.from_call(\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 353, in from_call\n    result: TResult | None = func()\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 245, in <lambda>\n    lambda: runtest_hook(item=item, **kwds),\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_hooks.py", line 512, in __call__\n    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_manager.py", line 120, in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_callers.py", line 121, in _multicall\n    res = hook_impl.function(*args)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\runner.py", line 179, in pytest_runtest_call\n    item.runtest()\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\python.py", line 1720, in runtest\n    self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_hooks.py", line 512, in __call__\n    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_manager.py", line 120, in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\pluggy\\_callers.py", line 121, in _multicall\n    res = hook_impl.function(*args)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\venv\\Lib\\site-packages\\_pytest\\python.py", line 166, in pytest_pyfunc_call\n    result = testfunction(**testargs)\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\bot\\tests\\test_tasks.py", line 278, in test_process_bot_message_async_returns_error_after_retries\n    result = process_bot_message_async.run(\n  File "C:\\Users\\joshe\\Desktop\\Zenz\\zenzspa_project\\bot\\tasks.py", line 269, in process_bot_message_async\n    logger.exception("\u274c Error procesando mensaje en task %s: %s", self.request.id, e)\nMessage: '\u274c Error procesando mensaje en task %s: %s'\nArguments: (None, ValueError('boom'))
=========================== short test summary info ===========================
FAILED bot/tests/test_tasks.py::TestBotTasks::test_process_bot_message_async_returns_error_after_retries
=================== 1 failed, 14 passed, 1 warning in 4.63s ===================
