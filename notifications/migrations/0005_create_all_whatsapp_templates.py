# Generated by Claude Code on 2025-11-26

from django.db import migrations


def create_whatsapp_templates(apps, schema_editor):
    Template = apps.get_model("notifications", "NotificationTemplate")

    templates = [
        # ===== RECORDATORIOS DE CITAS =====
        (
            "APPOINTMENT_REMINDER_24H",
            "WHATSAPP",
            "",  # WhatsApp no usa subject
            """ğŸ—“ï¸ *RECORDATORIO DE CITA*
Hola {{ user_name }},

Te recordamos que tienes una cita maÃ±ana:
ğŸ“… *Fecha:* {{ start_date }}
ğŸ• *Hora:* {{ start_time }}
ğŸ’† *Servicios:* {{ services }}

ğŸ’° *Total:* ${{ total }}

_Si no puedes asistir, cancela con al menos 24h de anticipaciÃ³n._

Â¡Te esperamos en StudioZens!"""
        ),
        (
            "APPOINTMENT_REMINDER_2H",
            "WHATSAPP",
            "",
            """â° *RECORDATORIO - CITA EN 2 HORAS*
Hola {{ user_name }},

Tu cita es en 2 horas:
ğŸ• {{ start_time }}
ğŸ’† {{ services }}

ğŸ“ Recuerda llegar 5 minutos antes.

Â¡Nos vemos pronto!"""
        ),

        # ===== CANCELACIONES DE CITAS =====
        (
            "APPOINTMENT_CANCELLED_AUTO",
            "WHATSAPP",
            "",
            """âŒ *CITA CANCELADA AUTOMÃTICAMENTE*
Hola {{ user_name }},

Tu cita del {{ start_time }} fue cancelada porque no se realizÃ³ el anticipo a tiempo.

ğŸ’¡ *Â¿AÃºn quieres el servicio?*
Agenda nuevamente desde la app.

_Cualquier duda, contÃ¡ctanos._"""
        ),

        # ===== NO-SHOW =====
        (
            "APPOINTMENT_NO_SHOW_CREDIT",
            "WHATSAPP",
            "",
            """ğŸ’³ *CRÃ‰DITO GENERADO*
Hola {{ user_name }},

Tu cita del {{ start_time }} fue marcada como No-Show.

âœ… Se generÃ³ un crÃ©dito de *${{ credit_amount }}* en tu cuenta.

Puedes usarlo en tu prÃ³xima reserva.

_Gracias por tu comprensiÃ³n._"""
        ),
        (
            "APPOINTMENT_NO_SHOW_PENALTY",
            "WHATSAPP",
            "",
            """âš ï¸ *CITA NO-SHOW*
Hola {{ user_name }},

Tu cita del {{ start_time }} fue marcada como No-Show.

SegÃºn nuestra polÃ­tica, no aplica reembolso.

_Si tuviste algÃºn inconveniente, contÃ¡ctanos._"""
        ),

        # ===== LISTA DE ESPERA =====
        (
            "APPOINTMENT_WAITLIST_AVAILABLE",
            "WHATSAPP",
            "",
            """ğŸ‰ *ESPACIO DISPONIBLE EN TU FECHA*
Hola {{ user_name }},

Â¡Buenas noticias! Se liberÃ³ un espacio para:
ğŸ“… {{ date }}
ğŸ• {{ time }}
ğŸ’† {{ service }}

ğŸ’¡ *Reserva ahora* desde la app antes que se agote.

_Este espacio puede llenarse rÃ¡pido._"""
        ),

        # ===== VIP MEMBERSHIP =====
        (
            "VIP_RENEWAL_FAILED",
            "WHATSAPP",
            "",
            """âš ï¸ *ERROR EN RENOVACIÃ“N VIP*
Hola {{ user_name }},

No pudimos renovar tu membresÃ­a VIP porque:
{{ failure_reason }}

ğŸ’¡ *Para mantener tus beneficios:*
Actualiza tu mÃ©todo de pago en la app.

_Tu membresÃ­a vence el {{ expiry_date }}_"""
        ),
        (
            "VIP_MEMBERSHIP_EXPIRED",
            "WHATSAPP",
            "",
            """ğŸ“¢ *MEMBRESÃA VIP EXPIRADA*
Hola {{ user_name }},

Tu membresÃ­a VIP ha expirado.

ğŸ’” Perdiste acceso a:
â€¢ Descuentos exclusivos
â€¢ Prioridad en citas
â€¢ Vouchers mensuales

ğŸ’¡ *Renueva ahora* para recuperar tus beneficios.

_Â¡Te extraÃ±amos!_"""
        ),
        (
            "VIP_LOYALTY_MILESTONE",
            "WHATSAPP",
            "",
            """ğŸŠ *Â¡FELICITACIONES VIP!*
Hola {{ user_name }},

Alcanzaste {{ visits_count }} visitas como miembro VIP.

ğŸ *Recompensa desbloqueada:*
{{ reward_description }}

_Gracias por tu lealtad._

Â¡Disfruta tu beneficio! ğŸ’œ"""
        ),

        # ===== VOUCHERS =====
        (
            "VOUCHER_EXPIRING_SOON",
            "WHATSAPP",
            "",
            """â° *TU VOUCHER ESTÃ POR EXPIRAR*
Hola {{ user_name }},

Tienes un voucher de *${{ amount }}* que vence:
ğŸ“… {{ expiry_date }}

ğŸ’¡ *Ãšsalo antes que expire:*
{{ voucher_code }}

_No dejes pasar esta oportunidad._"""
        ),

        # ===== PAGOS =====
        (
            "PAYMENT_STATUS_APPROVED",
            "WHATSAPP",
            "",
            """âœ… *PAGO APROBADO*
Hola {{ user_name }},

Tu pago fue procesado exitosamente:
ğŸ’° *Monto:* ${{ amount }}
ğŸ†” *Referencia:* {{ reference }}
ğŸ“‹ *Concepto:* {{ concept }}

{{ extra_info }}

_Gracias por tu pago._"""
        ),
        (
            "PAYMENT_STATUS_DECLINED",
            "WHATSAPP",
            "",
            """âŒ *PAGO RECHAZADO*
Hola {{ user_name }},

Tu pago fue rechazado:
ğŸ’° *Monto:* ${{ amount }}
ğŸ†” *Referencia:* {{ reference }}
âš ï¸ *Motivo:* {{ decline_reason }}

ğŸ’¡ *Intenta de nuevo:*
â€¢ Verifica saldo disponible
â€¢ Confirma datos de tarjeta
â€¢ Contacta tu banco

_Si el problema persiste, contÃ¡ctanos._"""
        ),
        (
            "PAYMENT_STATUS_ERROR",
            "WHATSAPP",
            "",
            """âš ï¸ *ERROR EN PAGO*
Hola {{ user_name }},

OcurriÃ³ un error procesando tu pago:
ğŸ’° *Monto:* ${{ amount }}
ğŸ†” *Referencia:* {{ reference }}

ğŸ’¡ *Intenta nuevamente* en unos minutos.

_Si el error persiste, contÃ¡ctanos para asistencia._"""
        ),

        # ===== Ã“RDENES MARKETPLACE =====
        (
            "ORDER_SHIPPED",
            "WHATSAPP",
            "",
            """ğŸšš *ORDEN ENVIADA*
Hola {{ user_name }},

Tu orden *#{{ order_id }}* ha sido enviada.

ğŸ“¦ *GuÃ­a de rastreo:* {{ tracking_number }}
ğŸ“… *Entrega estimada:* {{ estimated_delivery }}

ğŸ’¡ Rastrea tu pedido con el nÃºmero de guÃ­a.

_Â¡Gracias por tu compra!_"""
        ),
        (
            "ORDER_DELIVERED",
            "WHATSAPP",
            "",
            """ğŸ‰ *ORDEN ENTREGADA*
Hola {{ user_name }},

Tu orden *#{{ order_id }}* fue entregada exitosamente.

âœ… *Entregado:* {{ delivery_date }}

ğŸ’¡ *Â¿Todo llegÃ³ bien?*
CalifÃ­canos en la app.

_Â¡Esperamos verte pronto!_"""
        ),
        (
            "ORDER_CANCELLED",
            "WHATSAPP",
            "",
            """âŒ *ORDEN CANCELADA*
Hola {{ user_name }},

Tu orden *#{{ order_id }}* fue cancelada.

ğŸ“‹ *Motivo:* {{ cancellation_reason }}
ğŸ’° *Reembolso:* {{ refund_info }}

_Si tienes dudas, contÃ¡ctanos._"""
        ),
        (
            "ORDER_READY_FOR_PICKUP",
            "WHATSAPP",
            "",
            """ğŸª *ORDEN LISTA PARA RECOGER*
Hola {{ user_name }},

Tu orden *#{{ order_id }}* estÃ¡ lista para recoger en tienda.

ğŸ“ *DirecciÃ³n:* {{ store_address }}
ğŸ• *Horario:* {{ store_hours }}

ğŸ’¡ Lleva tu cÃ³digo: *{{ pickup_code }}*

_Â¡Te esperamos!_"""
        ),

        # ===== DEVOLUCIONES =====
        (
            "ORDER_RETURN_REQUESTED",
            "WHATSAPP",
            "",
            """ğŸ”„ *SOLICITUD DE DEVOLUCIÃ“N RECIBIDA*
Hola {{ user_name }},

Recibimos tu solicitud de devoluciÃ³n:
ğŸ“¦ *Orden:* #{{ order_id }}
ğŸ“‹ *Motivo:* {{ return_reason }}

â³ *Estamos revisando tu caso.*
Te notificaremos la decisiÃ³n en 24-48 horas.

_Gracias por tu paciencia._"""
        ),
        (
            "ORDER_RETURN_APPROVED",
            "WHATSAPP",
            "",
            """âœ… *DEVOLUCIÃ“N APROBADA*
Hola {{ user_name }},

Tu devoluciÃ³n fue aprobada:
ğŸ“¦ *Orden:* #{{ order_id }}
ğŸ’° *CrÃ©ditos abonados:* ${{ refund_amount }}

Puedes usar tus crÃ©ditos en tu prÃ³xima compra.

_Â¡Esperamos verte pronto!_"""
        ),
        (
            "ORDER_CREDIT_ISSUED",
            "WHATSAPP",
            "",
            """ğŸ’³ *CRÃ‰DITOS ABONADOS*
Hola {{ user_name }},

Se abonaron *${{ credit_amount }}* a tu cuenta:
ğŸ“‹ *Concepto:* {{ reason }}
ğŸ†” *Orden:* #{{ order_id }}

Usa tus crÃ©ditos en tu prÃ³xima compra.

_Â¡Gracias por tu preferencia!_"""
        ),

        # ===== ALERTAS DE STOCK (Admin) =====
        (
            "STOCK_LOW_ALERT",
            "WHATSAPP",
            "",
            """âš ï¸ *ALERTA DE STOCK BAJO*
Los siguientes productos tienen pocas unidades:

{{ items_list }}

ğŸ’¡ *AcciÃ³n requerida:*
Reabastecer inventario

_NotificaciÃ³n automÃ¡tica del sistema_"""
        ),

        # ===== USUARIO PERSONA NON GRATA (Admin) =====
        (
            "USER_FLAGGED_NON_GRATA",
            "WHATSAPP",
            "",
            """ğŸš¨ *ALERTA: USUARIO MARCADO COMO NON GRATA*
Usuario: {{ user_name }}
Email: {{ user_email }}
TelÃ©fono: {{ user_phone }}

ğŸ“‹ *Motivo:* {{ flag_reason }}
ğŸ”’ *AcciÃ³n:* {{ action_taken }}

ğŸ’¡ *Revisar perfil en admin:*
{{ admin_url }}

_NotificaciÃ³n de seguridad_"""
        ),

        # ===== BOT HANDOFF (Staff/Admin) =====
        (
            "BOT_HANDOFF_CREATED",
            "WHATSAPP",
            "",
            """ğŸš¨ *NUEVA SOLICITUD DE ATENCIÃ“N HUMANA*
{{ score_emoji }} Score: {{ client_score }}/100

ğŸ‘¤ *Cliente:* {{ client_name }}
ğŸ“ *Tel:* {{ client_phone }}
{{ warning_text }}

ğŸ’¬ *Dijo:* "{{ escalation_message }}"

ğŸ’¡ *Responder desde admin:*
{{ admin_url }}

_Atender cuanto antes_"""
        ),
        (
            "BOT_HANDOFF_EXPIRED",
            "WHATSAPP",
            "",
            """â° *HANDOFF SIN ATENDER - EXPIRADO*
ğŸš¨ *ID:* {{ handoff_id }}
ğŸ‘¤ *Cliente:* {{ client_name }}
ğŸ“… *Creado:* {{ created_at }}

âš ï¸ *No se atendiÃ³ a tiempo*

ğŸ’¡ *Revisar caso:*
{{ admin_url }}

_Considerar recontactar al cliente_"""
        ),

        # ===== BOT SECURITY (Admin) =====
        (
            "BOT_SECURITY_ALERT",
            "WHATSAPP",
            "",
            """ğŸ” *ALERTA DE SEGURIDAD - BOT*
Tipo: {{ alert_type }}
Usuario: {{ user_identifier }}

ğŸ“‹ *Detalle:*
{{ alert_detail }}

â° {{ timestamp }}

ğŸ’¡ *Revisar logs en admin*

_NotificaciÃ³n automÃ¡tica del sistema_"""
        ),
        (
            "BOT_AUTO_BLOCK",
            "WHATSAPP",
            "",
            """ğŸš« *USUARIO AUTO-BLOQUEADO*
Usuario: {{ user_identifier }}

ğŸ“‹ *Motivo:*
{{ block_reason }}

ğŸ”’ *AcciÃ³n tomada:* Bloqueo automÃ¡tico
â° {{ timestamp }}

ğŸ’¡ *Revisar caso en admin:*
{{ admin_url }}

_Bloqueo preventivo del sistema_"""
        ),
    ]

    for event_code, channel, subject, body in templates:
        Template.objects.get_or_create(
            event_code=event_code,
            channel=channel,
            defaults={
                "subject_template": subject,
                "body_template": body,
                "is_active": True,
            },
        )


def delete_whatsapp_templates(apps, schema_editor):
    Template = apps.get_model("notifications", "NotificationTemplate")
    Template.objects.filter(channel="WHATSAPP").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("notifications", "0004_add_whatsapp_channel"),
    ]

    operations = [
        migrations.RunPython(create_whatsapp_templates, delete_whatsapp_templates),
    ]
