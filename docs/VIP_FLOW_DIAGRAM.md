# Sistema VIP - Diagramas de Flujo

## ğŸ”„ Flujo 1: Compra Inicial de MembresÃ­a VIP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario   â”‚
â”‚  (Cliente)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Visita /vip
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PÃ¡gina VIP Landing        â”‚
â”‚                             â”‚
â”‚  â€¢ Beneficios VIP           â”‚
â”‚  â€¢ Precio: $39,900/mes      â”‚
â”‚  â€¢ [BotÃ³n Suscribirse]      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Click "Suscribirse"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend valida:          â”‚
â”‚   âœ“ Usuario autenticado?    â”‚
â”‚   âœ“ No es VIP ya?           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. POST /api/v1/finances/payments/vip-subscription/initiate/
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend Django            â”‚
â”‚                             â”‚
â”‚  â€¢ Genera reference Ãºnico   â”‚
â”‚  â€¢ Calcula signature        â”‚
â”‚  â€¢ Retorna datos Wompi      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Retorna WompiCheckoutData
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend abre Widget      â”‚
â”‚                             â”‚
â”‚   new WidgetCheckout({      â”‚
â”‚     publicKey,              â”‚
â”‚     amountInCents,          â”‚
â”‚     reference,              â”‚
â”‚     signature,              â”‚
â”‚     redirectUrl             â”‚
â”‚   })                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Usuario ingresa datos de tarjeta
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Wompi Gateway             â”‚
â”‚                             â”‚
â”‚  â€¢ Procesa pago             â”‚
â”‚  â€¢ Tokeniza tarjeta         â”‚
â”‚  â€¢ Genera transaction_id    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ 6a. Pago APROBADO   â”‚ 6b. Pago RECHAZADO â”‚
       â–¼                     â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ Wompi envÃ­a  â”‚      â”‚ Wompi envÃ­a      â”‚       â”‚
â”‚ webhook      â”‚      â”‚ webhook          â”‚       â”‚
â”‚ (APPROVED)   â”‚      â”‚ (DECLINED/ERROR) â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
       â”‚                     â”‚                    â”‚
       â”‚ 7. Backend procesa webhook              â”‚
       â–¼                     â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ Backend SUCCESS: â”‚  â”‚ Backend FAILURE: â”‚       â”‚
â”‚                  â”‚  â”‚                  â”‚       â”‚
â”‚ â€¢ user.role=VIP  â”‚  â”‚ â€¢ payment.status â”‚       â”‚
â”‚ â€¢ vip_expires=   â”‚  â”‚   = DECLINED     â”‚       â”‚
â”‚   today+30 dÃ­as  â”‚  â”‚ â€¢ No cambia user â”‚       â”‚
â”‚ â€¢ vip_active=    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   today          â”‚                             â”‚
â”‚ â€¢ vip_auto_renew â”‚                             â”‚
â”‚   = true         â”‚                             â”‚
â”‚ â€¢ Guarda token   â”‚                             â”‚
â”‚ â€¢ Crea Payment   â”‚                             â”‚
â”‚ â€¢ Crea SubscLog  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
       â”‚                                         â”‚
       â”‚ 8. Wompi redirige browser              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /vip/payment-result        â”‚
â”‚  ?id=TRANSACTION_ID         â”‚
â”‚                             â”‚
â”‚  â€¢ Espera 3 segundos        â”‚
â”‚  â€¢ Consulta payments/my/    â”‚
â”‚  â€¢ Verifica status          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Si APPROVED      â”‚ Si DECLINED     â”‚
       â–¼                  â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ PÃ¡gina       â”‚    â”‚ PÃ¡gina       â”‚       â”‚
â”‚ SUCCESS:     â”‚    â”‚ ERROR:       â”‚       â”‚
â”‚              â”‚    â”‚              â”‚       â”‚
â”‚ Â¡Bienvenido  â”‚    â”‚ Error en el  â”‚       â”‚
â”‚ a VIP!       â”‚    â”‚ pago         â”‚       â”‚
â”‚              â”‚    â”‚              â”‚       â”‚
â”‚ [Ver         â”‚    â”‚ [Intentar    â”‚       â”‚
â”‚  MembresÃ­a]  â”‚    â”‚  de nuevo]   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
       â”‚                                    â”‚
       â”‚ 9. Usuario navega                 â”‚
       â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   Usuario ahora es VIP      â”‚            â”‚
â”‚                             â”‚            â”‚
â”‚  â€¢ Ve precios VIP           â”‚            â”‚
â”‚  â€¢ Badge VIP en perfil      â”‚            â”‚
â”‚  â€¢ Acceso a /vip/membership â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
```

---

## ğŸ” Flujo 2: RenovaciÃ³n AutomÃ¡tica Mensual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tarea Celery (diaria)      â”‚
â”‚  process_recurring_         â”‚
â”‚  subscriptions()            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Busca usuarios VIP con:
       â”‚    â€¢ vip_auto_renew = true
       â”‚    â€¢ vip_expires_at en 3 dÃ­as
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Encuentra: Usuario #123    â”‚
â”‚                             â”‚
â”‚  vip_expires_at: 2025-01-16 â”‚
â”‚  vip_payment_token: ***XXXX â”‚
â”‚  vip_failed_payments: 0     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Intenta cobrar usando token guardado
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PaymentService.            â”‚
â”‚  charge_recurrence_token()  â”‚
â”‚                             â”‚
â”‚  â€¢ Llama a Wompi API        â”‚
â”‚  â€¢ Usa vip_payment_token    â”‚
â”‚  â€¢ Monto: vip_monthly_price â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Ã‰XITO             â”‚ FALLO              â”‚
       â–¼                   â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ Backend:     â”‚    â”‚ Backend:         â”‚       â”‚
â”‚              â”‚    â”‚                  â”‚       â”‚
â”‚ â€¢ Extiende   â”‚    â”‚ â€¢ Incrementa     â”‚       â”‚
â”‚   vip_       â”‚    â”‚   vip_failed_    â”‚       â”‚
â”‚   expires_at â”‚    â”‚   payments += 1  â”‚       â”‚
â”‚   +30 dÃ­as   â”‚    â”‚                  â”‚       â”‚
â”‚ â€¢ Resetea    â”‚    â”‚ â€¢ EnvÃ­a notif:   â”‚       â”‚
â”‚   vip_       â”‚    â”‚   RENEWAL_FAILED â”‚       â”‚
â”‚   failed_    â”‚    â”‚                  â”‚       â”‚
â”‚   payments=0 â”‚    â”‚ Si failures>=3:  â”‚       â”‚
â”‚ â€¢ Crea nuevo â”‚    â”‚  â€¢ vip_auto_     â”‚       â”‚
â”‚   Payment    â”‚    â”‚    renew = false â”‚       â”‚
â”‚ â€¢ Crea nuevo â”‚    â”‚  â€¢ Notifica      â”‚       â”‚
â”‚   SubscLog   â”‚    â”‚    cancelaciÃ³n   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
```

---

## â° Flujo 3: ExpiraciÃ³n de MembresÃ­a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tarea Celery (diaria)      â”‚
â”‚  downgrade_expired_vips()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Busca usuarios VIP con:
       â”‚    â€¢ vip_expires_at < hoy
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Encuentra: Usuario #123    â”‚
â”‚                             â”‚
â”‚  role: VIP                  â”‚
â”‚  vip_expires_at: 2025-01-10 â”‚
â”‚  Hoy: 2025-01-13            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Downgrade a CLIENT
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend actualiza:         â”‚
â”‚                             â”‚
â”‚  â€¢ user.role = CLIENT       â”‚
â”‚  â€¢ user.vip_auto_renew =    â”‚
â”‚    false                    â”‚
â”‚  â€¢ user.vip_active_since =  â”‚
â”‚    null                     â”‚
â”‚  â€¢ user.vip_failed_         â”‚
â”‚    payments = 0             â”‚
â”‚  â€¢ Crea AuditLog            â”‚
â”‚  â€¢ EnvÃ­a notificaciÃ³n:      â”‚
â”‚    VIP_MEMBERSHIP_EXPIRED   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Usuario ve cambios
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario ahora CLIENT      â”‚
â”‚                             â”‚
â”‚  â€¢ Ve precios regulares     â”‚
â”‚  â€¢ No tiene badge VIP       â”‚
â”‚  â€¢ Puede volver a comprar   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ Flujo 4: Recompensa de Lealtad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tarea Celery (diaria)      â”‚
â”‚  check_vip_loyalty()        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Busca usuarios VIP con:
       â”‚    â€¢ vip_active_since hace
       â”‚      >= 3 meses continuos
       â”‚    â€¢ Sin recompensa reciente
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Encuentra: Usuario #123    â”‚
â”‚                             â”‚
â”‚  vip_active_since:          â”‚
â”‚    2024-10-13               â”‚
â”‚  Hoy: 2025-01-13            â”‚
â”‚  Meses: 3 âœ“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Otorga recompensa
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend crea:              â”‚
â”‚                             â”‚
â”‚  â€¢ Voucher para servicio    â”‚
â”‚    configurado en           â”‚
â”‚    loyalty_voucher_service  â”‚
â”‚  â€¢ Voucher.value = precio   â”‚
â”‚    del servicio             â”‚
â”‚  â€¢ Voucher.expiration_date  â”‚
â”‚    = hoy + 365 dÃ­as         â”‚
â”‚  â€¢ Crea LoyaltyRewardLog    â”‚
â”‚  â€¢ EnvÃ­a notificaciÃ³n:      â”‚
â”‚    LOYALTY_REWARD_ISSUED    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Usuario ve notificaciÃ³n
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NotificaciÃ³n Push         â”‚
â”‚                             â”‚
â”‚  Â¡Felicidades!              â”‚
â”‚  Has recibido un voucher    â”‚
â”‚  de Masaje Relajante 60min  â”‚
â”‚  por tu lealtad VIP         â”‚
â”‚                             â”‚
â”‚  [Ver mis vouchers]         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Usuario usa voucher
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario agenda cita con    â”‚
â”‚  voucher y servicio es      â”‚
â”‚  GRATIS                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš« Flujo 5: Cancelar Auto-RenovaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario   â”‚
â”‚    (VIP)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Va a /vip/membership
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Panel de MembresÃ­a        â”‚
â”‚                             â”‚
â”‚  Status: VIP Activo         â”‚
â”‚  Expira: 2025-02-13         â”‚
â”‚  Auto-renovaciÃ³n: âœ“ ON      â”‚
â”‚                             â”‚
â”‚  [Cancelar Auto-RenovaciÃ³n] â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Click "Cancelar"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Modal de ConfirmaciÃ³n     â”‚
â”‚                             â”‚
â”‚  Â¿EstÃ¡s seguro?             â”‚
â”‚  SeguirÃ¡s siendo VIP hasta  â”‚
â”‚  2025-02-13                 â”‚
â”‚                             â”‚
â”‚  [Cancelar] [Confirmar]     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Confirma
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend llama:            â”‚
â”‚  POST /api/v1/spa/vip/      â”‚
â”‚  cancel-subscription/       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Backend actualiza
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend:                   â”‚
â”‚                             â”‚
â”‚  â€¢ user.vip_auto_renew =    â”‚
â”‚    false                    â”‚
â”‚  â€¢ NO cambia role           â”‚
â”‚  â€¢ NO cambia vip_expires_at â”‚
â”‚  â€¢ Retorna confirmaciÃ³n     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Frontend actualiza UI
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Panel de MembresÃ­a        â”‚
â”‚                             â”‚
â”‚  Status: VIP Activo         â”‚
â”‚  Expira: 2025-02-13         â”‚
â”‚  Auto-renovaciÃ³n: âœ— OFF     â”‚
â”‚                             â”‚
â”‚  âš ï¸ No se renovarÃ¡          â”‚
â”‚     automÃ¡ticamente.        â”‚
â”‚     Puedes volver a         â”‚
â”‚     suscribirte.            â”‚
â”‚                             â”‚
â”‚  [Renovar MembresÃ­a]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Flujo 6: Estados de la UI segÃºn Usuario

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              USUARIO NO AUTENTICADO                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /vip                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Hazte VIP                           â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Iniciar SesiÃ³n para Suscribirte]  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  Servicios:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Masaje Relajante                   â”‚           â”‚
â”‚  â”‚  Precio: $80,000                    â”‚           â”‚
â”‚  â”‚  Precio VIP: $60,000 â­              â”‚           â”‚
â”‚  â”‚  [Inicia sesiÃ³n para precio VIP]   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              USUARIO CLIENTE (No VIP)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /vip                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Hazte VIP                           â”‚           â”‚
â”‚  â”‚  $39,900/mes                         â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Suscribirse Ahora]                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  Servicios:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Masaje Relajante                   â”‚           â”‚
â”‚  â”‚  Precio: $80,000                    â”‚           â”‚
â”‚  â”‚  â­ Precio VIP: $60,000              â”‚           â”‚
â”‚  â”‚  [Hazte VIP para ahorrar $20,000]  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  /vip/membership â†’ REDIRECT /vip                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USUARIO VIP (Activo, Auto-Renew ON)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /vip                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Ya eres VIP                         â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Ver Mi MembresÃ­a]                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  /vip/membership                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ğŸ‘‘ Miembro VIP                      â”‚           â”‚
â”‚  â”‚  Expira: 2025-02-13                 â”‚           â”‚
â”‚  â”‚  Auto-renovaciÃ³n: âœ“ Activa          â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  Lealtad: 2/3 meses â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘         â”‚           â”‚
â”‚  â”‚  PrÃ³xima recompensa en 1 mes        â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Cancelar Auto-RenovaciÃ³n]         â”‚           â”‚
â”‚  â”‚  [Ver Historial de Pagos]           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  Servicios:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Masaje Relajante    ğŸ‘‘ VIP          â”‚           â”‚
â”‚  â”‚  $80,000 â†’ $60,000                  â”‚           â”‚
â”‚  â”‚  Ahorras: $20,000                   â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Reservar]                         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        USUARIO VIP (Activo, Auto-Renew OFF)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /vip/membership                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ğŸ‘‘ Miembro VIP                      â”‚           â”‚
â”‚  â”‚  Expira: 2025-02-13                 â”‚           â”‚
â”‚  â”‚  Auto-renovaciÃ³n: âœ— Desactivada     â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  âš ï¸ Tu membresÃ­a no se renovarÃ¡     â”‚           â”‚
â”‚  â”‚     automÃ¡ticamente.                â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Renovar Ahora]                    â”‚           â”‚
â”‚  â”‚  [Ver Historial de Pagos]           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                     â”‚
â”‚  Si estÃ¡ a 7 dÃ­as o menos de expirar:              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  âš ï¸ Tu membresÃ­a expira en 5 dÃ­as   â”‚           â”‚
â”‚  â”‚  [Renovar Ahora]                    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USUARIO VIP (Con Fallos de Pago)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /vip/membership                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ğŸ‘‘ Miembro VIP                      â”‚           â”‚
â”‚  â”‚  Expira: 2025-01-16                 â”‚           â”‚
â”‚  â”‚  Auto-renovaciÃ³n: âš ï¸ Con problemas   â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  â›” El Ãºltimo cobro automÃ¡tico       â”‚           â”‚
â”‚  â”‚     fallÃ³. Intentos restantes: 2    â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  Por favor actualiza tu mÃ©todo      â”‚           â”‚
â”‚  â”‚  de pago para mantener tu           â”‚           â”‚
â”‚  â”‚  membresÃ­a VIP.                     â”‚           â”‚
â”‚  â”‚                                      â”‚           â”‚
â”‚  â”‚  [Actualizar MÃ©todo de Pago]        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Flujo de Seguridad: Webhook de Wompi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Wompi Gateway             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/v1/finances/webhooks/wompi/
       â”‚ Headers:
       â”‚   x-event: transaction.updated
       â”‚   x-signature: hash_signature
       â”‚
       â”‚ Body:
       â”‚   {
       â”‚     event: "transaction.updated",
       â”‚     data: {
       â”‚       transaction: {
       â”‚         id: "123-456",
       â”‚         status: "APPROVED",
       â”‚         amount_in_cents: 3990000,
       â”‚         reference: "vip_sub_123_...",
       â”‚         payment_method: {...},
       â”‚         customer_data: {...}
       â”‚       }
       â”‚     },
       â”‚     timestamp: 1639430400,
       â”‚     signature: {...}
       â”‚   }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend WompiWebhookView   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Validar firma de seguridad
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Verificar signature con    â”‚
â”‚  WOMPI_EVENT_SECRET         â”‚
â”‚                             â”‚
â”‚  Si invÃ¡lida â†’ 403 Forbiddenâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Buscar Payment por reference
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment.objects.get(       â”‚
â”‚    transaction_id=reference â”‚
â”‚  )                          â”‚
â”‚                             â”‚
â”‚  Si no existe â†’ 404         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Aplicar status del gateway
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PaymentService.            â”‚
â”‚  apply_gateway_status()     â”‚
â”‚                             â”‚
â”‚  Si payment_type ==         â”‚
â”‚  VIP_SUBSCRIPTION:          â”‚
â”‚    VipSubscriptionService.  â”‚
â”‚    fulfill_subscription()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Retornar 200 OK a Wompi
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response: 200 OK           â”‚
â”‚  Wompi marca webhook como   â”‚
â”‚  procesado                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Diagrama de Estados del Pago

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PENDING â”‚  â† Creado al iniciar pago
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚                  â”‚
         â–¼               â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚APPROVED â”‚   â”‚ DECLINED â”‚      â”‚  ERROR   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚                  â”‚
         â”‚              â”‚                  â”‚
         â–¼              â–¼                  â–¼
    Extender      No cambia           Reintentar
    membresÃ­a     nada               o cancelar
```

---

## ğŸ¯ Matriz de Decisiones: Â¿QuÃ© Mostrar?

| CondiciÃ³n | Mostrar |
|-----------|---------|
| `!user` | Landing /vip con "Inicia SesiÃ³n" |
| `user && !user.is_vip` | Landing /vip con "Suscribirse" |
| `user.is_vip && user.vip_auto_renew` | Panel membresÃ­a + "Cancelar Auto-RenovaciÃ³n" |
| `user.is_vip && !user.vip_auto_renew` | Panel membresÃ­a + "Renovar" + Advertencia |
| `user.vip_failed_payments > 0` | Alerta de fallo de pago + "Actualizar MÃ©todo" |
| `daysUntilExpiry <= 7 && !vip_auto_renew` | Advertencia de expiraciÃ³n prÃ³xima |
| `service.vip_price && user.is_vip` | Precio VIP (tachado regular) |
| `service.vip_price && !user.is_vip` | Precio regular + "Hazte VIP" |

---

**Ãšltima actualizaciÃ³n:** 13 de Diciembre, 2024
