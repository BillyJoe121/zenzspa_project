# Análisis exhaustivo de rutas de notificaciones

## Detalle por evento
### Recordatorios y citas
#### APPOINTMENT_REMINDER_24H
- **Disparo**: `_send_reminder_for_appointment` prepara el contexto y llama a `NotificationService` cuando la tarea `send_appointment_reminder` detecta citas entre 24 y 25 horas hacia adelante (`spa/tasks.py:20-82`).
- **Contexto**: `user_name`, `start_date`, `start_time`, `services`, `total`, todos formateados para plantillas (`spa/tasks.py:38-45`).
- **Canales/destinatarios**: Cliente dueño de la cita; WhatsApp primero (tiene Content SID productivo) y Email de respaldo si existe plantilla activa (`notifications/twilio_templates.py:15-25`).
- **Registro**: Cada envío queda en `NotificationLog` con payload renderizado y metadata de fallback (`notifications/models.py:147`).

#### APPOINTMENT_REMINDER_2H
- **Disparo**: `check_upcoming_appointments_2h` recorre citas confirmadas/resched que ocurren exactamente dentro de 2h±5m y llama a `NotificationService` (`notifications/tasks.py:200-217`).
- **Contexto**: `appointment_id`, `start_time` en ISO y lista de `services` (`notifications/tasks.py:205-209`).
Modificacion: user_name, services
- **Canales/destinatarios**: Cliente; WhatsApp con fallback Email (SID aún placeholder → el mensaje será libre) (`notifications/twilio_templates.py:21-26`).
- **Registro**: `NotificationLog` + Celery task como el resto.

#### APPOINTMENT_CANCELLED_AUTO
- **Disparo**: `cancel_unpaid_appointments` cancela citas `PENDING_PAYMENT` que superan el SLA configurado y vehicula la notificación (`spa/tasks.py:126-187`).
- **Contexto**: Incluye `appointment_id` y `start_time` (`spa/tasks.py:159-165`).
Modificacion: user_name, start_date. 
- **Destinatario**: Cliente afectado. Eventual WhatsApp fallback a Email; SID placeholder (`notifications/twilio_templates.py:29-34`).
- **Registro**: `NotificationLog` con metadata del SLA (ver metadata en `notifications/services.py:180`).

#### APPOINTMENT_NO_SHOW_CREDIT / APPOINTMENT_NO_SHOW_PENALTY
- **Disparo**: `AppointmentViewSet.mark_as_no_show` (acción admin/staff) marca la cita como `CANCELLED` + `NO_SHOW` y decide el event_code según si se generó crédito (`spa/views/appointments/appointment_viewset.py:400-455`).
- **Contexto**: `appointment_id`, `start_time`, `credit_amount` (`spa/views/appointments/appointment_viewset.py:437-444`).
Modificacion: user_name, start_date, credit_amount
- **Destinatario**: Cliente; WhatsApp fallback Email (ambos con SID placeholder). Créditos > 0 usan `_CREDIT`, resto `_PENALTY`.
- **Registro**: `NotificationLog`.

#### APPOINTMENT_WAITLIST_AVAILABLE
- **Disparo**: `notify_waitlist_availability` cuando un slot se libera (tarea Celery) (`spa/tasks.py:85-124`).
- **Contexto**: `user_name`, `date`, `time`, `service` (toma datos de la entrada).
- **Destinatario**: Cliente en lista de espera; WhatsApp fallback Email (SID placeholder `notifications/twilio_templates.py:51-56`).
- **Registro**: `NotificationLog`.

### Fidelización y VIP
#### VIP_RENEWAL_FAILED
- **Disparo**: `finances/tasks.process_recurring_subscriptions` tras un cobro fallido y actualización de contadores (`finances/tasks.py:80-153`).
- **Contexto**: `failed_attempts` y `status` (“PAST_DUE” o “CANCELLED”) (`finances/tasks.py:134-148`).
Modificacion: user_name, status
- **Destinatario**: Usuario VIP en mora; WhatsApp → Email (SID placeholder `notifications/twilio_templates.py:59-64`).
- **Registro**: `NotificationLog`.

#### VIP_MEMBERSHIP_EXPIRED
- **Disparo**: `finances/tasks.downgrade_expired_vips` al degradar usuarios cuyo `vip_expires_at` quedó atrás (`finances/tasks.py:156-194`).
- **Contexto**: `expired_at` en ISO (`finances/tasks.py:183-189`).
Modificacion: user_name.
- **Destinatario**: Usuario degradado; WhatsApp fallback Email (SID placeholder `notifications/twilio_templates.py:65-70`).
- **Registro**: `NotificationLog`.

#### VIP_LOYALTY_MILESTONE *(pendiente)*
- **Definición**: Existe en el mapa Twilio con variables `user_name`, `visits_count`, `reward_description` (`notifications/twilio_templates.py:71-76`).
- **Estado**: No hay código que invoque `NotificationService` con este `event_code`; no se dispara hoy.

### Beneficios y vouchers
#### VOUCHER_EXPIRING_SOON
- **Disparo**: `notify_expiring_vouchers` recorre vouchers que vencerán en 3 días (`spa/tasks.py:257-285`).
- **Contexto**: `voucher_code`, `service_name`, `expires_at`. 
Modificacion: user_name, voucher amount (no se como se llama esta variable), expires_at, voucher_code.
- **Destinatario**: Dueño del voucher; WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:79-84`).
- **Registro**: `NotificationLog`.

### Pagos
#### PAYMENT_STATUS_APPROVED / DECLINED / ERROR
- **Disparo**: `_send_payment_status_notification` es llamado al final de `PaymentService.apply_gateway_status` para todos los pagos no PENDING (`finances/payments.py:96-142` + `:507-573`).
- **Contexto**: `amount`, `payment_type`, `reference`, `date`, `display_name`, `payment_id` (`finances/payments.py:551-558`).
Modificacion en approved: user_name, amount, reference, service.
Modificacion en declined: user_name, amount, reference, motivo del decline.
- **Destinatario**: Pagador registrado; obligatoriedad de email evita anónimos. WhatsApp→Email (SID placeholders `notifications/twilio_templates.py:86-104`).
- **Registro**: `NotificationLog`.

### Marketplace (clientes)
#### ORDER_READY_FOR_PICKUP
- **Disparo**: Dos capas: (1) `notify_order_status_change` (task) envía notificación básica con `order_id`, `tracking_number`, `delivered_at`, `status` (`marketplace/tasks.py:11-47`); (2) `MarketplaceNotificationService.send_order_status_update` enriquece el contexto (tracking, fecha estimada, dirección) y usa alta prioridad (`marketplace/services/notification_service.py:20-70`). Ambos caminos terminan en `NotificationService`.
- **Contexto**: Ver `marketplace/services/notification_service.py:36-57` para los campos dinámicos.
Modificacion: user_name, order_id, direccion de la tienda (carrera 64 #1c-87), codigo para la orden (puede ser el mismo order_id si es que no tenemos un generador de codigos aun)
Modificacion para order_cancelled: user_name, order_id, motivo de la cancelación. (esta se le puede pedir al admin y pasar lo que el admin escriba o que haya opciones en pildoras y que el admin las selecciones como: producto agotado etc)
- **Destinatario**: Usuario dueño de la orden. WhatsApp→Email (SID placeholders `notifications/twilio_templates.py:107-130`).
- **Registro**: `NotificationLog`.

### Marketplace (admin)
#### STOCK_LOW_ALERT
- **Disparo**: `MarketplaceNotificationService.send_low_stock_alert` cuando la lógica de inventario detecta variantes bajo mínimo (`marketplace/services/notification_service.py:71-118`). Se invoca desde `InventoryService` (no en este diff) cuando se prenden alertas.
- **Contexto**: Cadena multilinea `items_list` con productos bajos en stock.

- **Destinatario**: Primer admin con teléfono configurado en `BotConfiguration` (o cualquier admin activo como fallback); WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:152-158`).
- **Registro**: `NotificationLog`.

### Usuarios bloqueados
#### USER_FLAGGED_NON_GRATA
- **Disparos**:
  - `FlagNonGrataView.perform_update` notifica al **usuario bloqueado** de su estatus (`users/views/admin_views.py:33-130`).
  - `send_non_grata_alert_to_admins` se usa cuando un número marcado intenta registrarse y se alerta al **admin** (`users/tasks.py:15-77`).
- **Contextos**: Para el cliente: `phone_number`, `notes`. Para admins: `user_name`, `user_email`, `user_phone`, `flag_reason`, `action_taken`, `admin_url` (`users/tasks.py:53-61`).
Modificacion: user_name, user_email, user_phone, flag_reason.
- **Canales/destinatarios**: Cliente (WhatsApp+Email) y admin (WhatsApp critical, ignora quiet hours) usando el mismo `event_code` (`notifications/twilio_templates.py:160-166`).
- **Registro**: `NotificationLog` (dos entradas separadas, una por cada destinatario). Además se crean `AdminNotification` y `AuditLog` en la vista (`users/views/admin_views.py:62-76`).

### Bot / Atención humana
#### BOT_HANDOFF_CREATED
- **Disparo**: `HandoffNotificationService.send_handoff_notification` es llamado desde múltiples puntos cuando el bot crea un `HumanHandoffRequest`: `bot/tasks/process_message.py:183-195`, `bot/services_shared.py:312`, `bot/views/webhook/bot_webhook.py:438`.
- **Contexto**: Métricas del lead (`score_emoji`, `client_score`, `client_name`, `client_phone`, `warning_text`, `escalation_message`, `admin_url`) (`bot/notifications.py:56-78`).
Modificacion: client_name, client_phone, client_score, escalation_mesagge.
- **Destinatarios**: Admin/staff con teléfono configurado. WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:168-174`).
- **Registro**: `NotificationLog`.

#### BOT_HANDOFF_EXPIRED
- **Disparo**: `check_handoff_timeout` programa un timeout de 5 minutos y, si el handoff sigue en estado `PENDING`, lo marca como `EXPIRED`, genera un mensaje automático y llama a `HandoffNotificationService.send_expired_handoff_notification` (`bot/tasks/cleanup.py:152-192`, `bot/notifications.py:245-297`).
- **Contexto**: `handoff_id`, `client_name`, `created_at`, `admin_url`.
Modificacion: client_name, created_at.
- **Destinatarios**: Admin/staff; prioridad `critical` para ignorar quiet hours (`bot/notifications.py:289-295`).
- **Registro**: `NotificationLog`.

ESTO NO DEBERÍA EXISTIR: 

#### BOT_HANDOFF_REPLY *(evento adicional #27)*
- **Disparo**: Cuando un miembro del staff responde desde la vista de handoff humano, `_send_client_notification` avisa al cliente (`bot/views/handoff_api.py:224-290`).
- **Contexto**: `message`, `staff_name`, `handoff_id`, `recipient_name`.
- **Destinatario**: Cliente asociado al handoff; prioriza WhatsApp. **No hay entrada en `TWILIO_TEMPLATE_MAP`**, aunque la migración `0006_add_bot_handoff_reply_template` sí creó una plantilla WhatsApp (`notifications/migrations/0006_add_bot_handoff_reply_template.py:7-34`). Esto explica por qué teníamos 27 eventos.
- **Registro**: `NotificationLog` + `HumanMessage` setea `delivery_channel='notification_service'` (`bot/views/handoff_api.py:275-279`).

### Bot / Seguridad
#### BOT_SECURITY_ALERT
- **Disparo**: `SuspiciousActivityAlertService.send_critical_activity_alert` corre al registrar una actividad con severidad CRITICAL via `record_activity` (`bot/suspicious_activity_detector/actions.py:11-66`).
- **Contexto**: `alert_type`, `user_identifier`, `alert_detail`, `timestamp` (`bot/alerts.py:90-103`).
- **Destinatarios**: Admin con teléfono configurado; prioridad critical + email masivo (`bot/alerts.py:98-122`).
- **Registro**: `NotificationLog`.














#### BOT_AUTO_BLOCK FALTA PLANTILLA
- **Disparo**: Cuando una IP supera el umbral configurado, `AutoBlockService.check_and_auto_block` crea la entrada en `IPBlocklist` y llama a `SuspiciousActivityAlertService.send_auto_block_notification` (`bot/alerts.py:287-360` + `bot/alerts.py:134-198`).
- **Contexto**: `user_identifier` (IP), `block_reason`, `timestamp`, `admin_url`.
Modificacion: user_name, block_reason, timestamp.
- **Destinatarios**: Admin; prioridad critical.
- **Registro**: `NotificationLog` y registro adicional en `IPBlocklist`.


#### ORDER_CREDIT_ISSUED FALTA PLANTILLA
- **Disparo**: `ReturnService.process_return` crea créditos y luego llama a `MarketplaceNotificationService.send_return_processed` (`marketplace/services/return_service.py:124-145`).
- **Contexto**: `user_name`, `credit_amount`, `reason`, `order_id` (`marketplace/services/notification_service.py:131-140`).
Modificacion: user_name, order_id, reason, credit_amount.
Modificacion: user_name, order_id, credit_amount.
- **Destinatario**: Cliente de la orden; WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:145-150`).
- **Registro**: `NotificationLog` y, adicionalmente, hay `AuditLog` de la devolución (`marketplace/services/return_service.py:147-159`).