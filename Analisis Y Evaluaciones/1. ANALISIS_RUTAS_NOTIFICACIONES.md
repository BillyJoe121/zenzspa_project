# Análisis exhaustivo de rutas de notificaciones

## Arquitectura general (aplica a todos los eventos)
- **Motor único**: Todo pasa por `NotificationService.send_notification()` y sus helpers (`notifications/services.py:60`). El servicio busca plantillas activas por `event_code`, respeta las preferencias del usuario (quiet hours, canales habilitados) y siempre prioriza WhatsApp, con Email como respaldo configurado; SMS y Push están deshabilitados.
- **Plantillas y canales**: Las plantillas viven en `NotificationTemplate` y se nutren tanto de migraciones (`notifications/migrations/0002_*`, `0005_*`, `0006_*`) como del mapa Twilio (`notifications/twilio_templates.py:12`). Solo `APPOINTMENT_REMINDER_24H` tiene un Content SID real; los demás SIDs comienzan en `HX000…`, por lo que `is_template_configured()` devolverá falso y el envío WhatsApp caerá al mensaje dinámico construido con `subject/body`.
- **Registro y trazabilidad**: Cada intento genera un `NotificationLog` con `payload`, `metadata`, `status` y conteo de reintentos (`notifications/models.py:147`). Esto cubre la necesidad de saber “dónde queda registrada” cada notificación.
- **Entrega real**: Celery invoca `notifications/tasks.send_notification_task` para sacar las colas, reintentar y hacer fallback de canal si falla el principal (`notifications/tasks.py:1-120`). En WhatsApp, `_dispatch_channel` usa `WhatsAppService` y el mapa Twilio (`notifications/tasks.py:92-166`).
- **Limpieza y monitoreo**: `cleanup_old_notification_logs` borra registros viejos (`notifications/tasks.py:220`). Los Webhooks del bot consultan `NotificationLog` para saber la última notificación enviada a un número (`bot/views/webhook/whatsapp_webhook.py:137`).

## Resumen de rutas
Hay **27 event_codes** activos o predefinidos. El mapa Twilio enumeraba 26, pero encontramos un evento adicional (`BOT_HANDOFF_REPLY`) que se dispara cuando el staff responde a un handoff. Tres códigos (`VIP_LOYALTY_MILESTONE`, `ORDER_RETURN_REQUESTED`, `ORDER_RETURN_APPROVED`) todavía no tienen disparadores en la base de código.

### Tabla rápida
| Event code | Dominio | Entrada principal |
|------------|---------|-------------------|
| APPOINTMENT_REMINDER_24H | Citas | `_send_reminder_for_appointment` (`spa/tasks.py:20`)
| APPOINTMENT_REMINDER_2H | Citas | `check_upcoming_appointments_2h` (`notifications/tasks.py:200`)
| APPOINTMENT_CANCELLED_AUTO | Citas | `cancel_unpaid_appointments` (`spa/tasks.py:126`)
| APPOINTMENT_NO_SHOW_CREDIT/PENALTY | Citas | `AppointmentViewSet.mark_as_no_show` (`spa/views/appointments/appointment_viewset.py:400`)
| APPOINTMENT_WAITLIST_AVAILABLE | Citas | `notify_waitlist_availability` (`spa/tasks.py:85`)
| VIP_RENEWAL_FAILED | VIP | `process_recurring_subscriptions` (`finances/tasks.py:80`)
| VIP_MEMBERSHIP_EXPIRED | VIP | `downgrade_expired_vips` (`finances/tasks.py:156`)
| VIP_LOYALTY_MILESTONE | VIP | **Sin disparador**
| VOUCHER_EXPIRING_SOON | Vouchers | `notify_expiring_vouchers` (`spa/tasks.py:257`)
| PAYMENT_STATUS_APPROVED/DECLINED/ERROR | Pagos | `PaymentService.apply_gateway_status` (`finances/payments.py:96` + `_send_payment_status_notification` `:507`)
| ORDER_SHIPPED/DELIVERED/CANCELLED/READY_FOR_PICKUP | Marketplace | `notify_order_status_change` (`marketplace/tasks.py:11`) y `MarketplaceNotificationService.send_order_status_update` (`marketplace/services/notification_service.py:20`)
| ORDER_RETURN_REQUESTED/APPROVED | Devoluciones | **Sin disparador**
| ORDER_CREDIT_ISSUED | Devoluciones | `MarketplaceNotificationService.send_return_processed` (`marketplace/services/notification_service.py:120`)
| STOCK_LOW_ALERT | Marketplace Admin | `MarketplaceNotificationService.send_low_stock_alert` (`marketplace/services/notification_service.py:71`)
| USER_FLAGGED_NON_GRATA | Usuarios/Admin | `FlagNonGrataView` (`users/views/admin_views.py:33`) y `send_non_grata_alert_to_admins` (`users/tasks.py:15`)
| BOT_HANDOFF_CREATED | Bot | `HandoffNotificationService.send_handoff_notification` (llamado desde `bot/tasks/process_message.py:183` y `bot/services_shared.py:312`)
| BOT_HANDOFF_EXPIRED | Bot | `check_handoff_timeout` (`bot/tasks/cleanup.py:152`) + `HandoffNotificationService.send_expired_handoff_notification` (`bot/notifications.py:245`)
| BOT_HANDOFF_REPLY | Bot | `HumanHandoffViewSet._send_client_notification` (`bot/views/handoff_api.py:224`)
| BOT_SECURITY_ALERT | Bot/Seguridad | `SuspiciousActivityAlertService.send_critical_activity_alert` (`bot/alerts.py:47`) disparado por `record_activity` (`bot/suspicious_activity_detector/actions.py:11`)
| BOT_AUTO_BLOCK | Bot/Seguridad | `AutoBlockService.check_and_auto_block` (`bot/alerts.py:287`) → `send_auto_block_notification` (`bot/alerts.py:134`)

## Detalle por evento
### Recordatorios y citas
#### APPOINTMENT_REMINDER_24H
- **Disparo**: `_send_reminder_for_appointment` prepara el contexto y llama a `NotificationService` cuando la tarea `send_appointment_reminder` detecta citas entre 24 y 25 horas hacia adelante (`spa/tasks.py:20-82`).
- **Contexto**: `user_name`, `start_date`, `start_time`, `services`, `total`, todos formateados para plantillas (`spa/tasks.py:38-45`).
- **Canales/destinatarios**: Cliente dueño de la cita; WhatsApp primero (tiene Content SID productivo) y Email de respaldo si existe plantilla activa (`notifications/twilio_templates.py:15-25`).
- **Registro**: Cada envío queda en `NotificationLog` con payload renderizado y metadata de fallback (`notifications/models.py:147`).

#### APPOINTMENT_REMINDER_2H
- **Disparo**: `check_upcoming_appointments_2h` recorre citas confirmadas/resched que ocurren exactamente dentro de 2h±5m y llama a `NotificationService` (`notifications/tasks.py:200-217`).
- **Contexto**: `appointment_id`, `start_time` en ISO y lista de `services` (`notifications/tasks.py:205-209`).
- **Canales/destinatarios**: Cliente; WhatsApp con fallback Email (SID aún placeholder → el mensaje será libre) (`notifications/twilio_templates.py:21-26`).
- **Registro**: `NotificationLog` + Celery task como el resto.

#### APPOINTMENT_CANCELLED_AUTO
- **Disparo**: `cancel_unpaid_appointments` cancela citas `PENDING_PAYMENT` que superan el SLA configurado y vehicula la notificación (`spa/tasks.py:126-187`).
- **Contexto**: Incluye `appointment_id` y `start_time` (`spa/tasks.py:159-165`).
- **Destinatario**: Cliente afectado. Eventual WhatsApp fallback a Email; SID placeholder (`notifications/twilio_templates.py:29-34`).
- **Registro**: `NotificationLog` con metadata del SLA (ver metadata en `notifications/services.py:180`).

#### APPOINTMENT_NO_SHOW_CREDIT / APPOINTMENT_NO_SHOW_PENALTY
- **Disparo**: `AppointmentViewSet.mark_as_no_show` (acción admin/staff) marca la cita como `CANCELLED` + `NO_SHOW` y decide el event_code según si se generó crédito (`spa/views/appointments/appointment_viewset.py:400-455`).
- **Contexto**: `appointment_id`, `start_time`, `credit_amount` (`spa/views/appointments/appointment_viewset.py:437-444`).
- **Destinatario**: Cliente; WhatsApp fallback Email (ambos con SID placeholder). Créditos > 0 usan `_CREDIT`, resto `_PENALTY`.
- **Registro**: `NotificationLog`.

#### APPOINTMENT_WAITLIST_AVAILABLE
- **Disparo**: `notify_waitlist_availability` cuando un slot se libera (tarea Celery) (`spa/tasks.py:85-124`).
- **Contexto**: `user_name`, `date`, `time`, `service` (toma datos de la entrada). 
- **Destinatario**: Cliente en lista de espera; WhatsApp fallback Email (SID placeholder `notifications/twilio_templates.py:51-56`).
- **Registro**: `NotificationLog`.

### Fidelización y VIP
#### VIP_RENEWAL_FAILED
- **Disparo**: `finances/tasks.process_recurring_subscriptions` tras un cobro fallido y actualización de contadores (`finances/tasks.py:80-153`).
- **Contexto**: `failed_attempts` y `status` (“PAST_DUE” o “CANCELLED”) (`finances/tasks.py:134-148`).
- **Destinatario**: Usuario VIP en mora; WhatsApp → Email (SID placeholder `notifications/twilio_templates.py:59-64`).
- **Registro**: `NotificationLog`.

#### VIP_MEMBERSHIP_EXPIRED
- **Disparo**: `finances/tasks.downgrade_expired_vips` al degradar usuarios cuyo `vip_expires_at` quedó atrás (`finances/tasks.py:156-194`).
- **Contexto**: `expired_at` en ISO (`finances/tasks.py:183-189`).
- **Destinatario**: Usuario degradado; WhatsApp fallback Email (SID placeholder `notifications/twilio_templates.py:65-70`).
- **Registro**: `NotificationLog`.

#### VIP_LOYALTY_MILESTONE *(pendiente)*
- **Definición**: Existe en el mapa Twilio con variables `user_name`, `visits_count`, `reward_description` (`notifications/twilio_templates.py:71-76`).
- **Estado**: No hay código que invoque `NotificationService` con este `event_code`; no se dispara hoy.

### Beneficios y vouchers
#### VOUCHER_EXPIRING_SOON
- **Disparo**: `notify_expiring_vouchers` recorre vouchers que vencerán en 3 días (`spa/tasks.py:257-285`).
- **Contexto**: `voucher_code`, `service_name`, `expires_at`. 
- **Destinatario**: Dueño del voucher; WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:79-84`).
- **Registro**: `NotificationLog`.

### Pagos
#### PAYMENT_STATUS_APPROVED / DECLINED / ERROR
- **Disparo**: `_send_payment_status_notification` es llamado al final de `PaymentService.apply_gateway_status` para todos los pagos no PENDING (`finances/payments.py:96-142` + `:507-573`).
- **Contexto**: `amount`, `payment_type`, `reference`, `date`, `display_name`, `payment_id` (`finances/payments.py:551-558`).
- **Destinatario**: Pagador registrado; obligatoriedad de email evita anónimos. WhatsApp→Email (SID placeholders `notifications/twilio_templates.py:86-104`).
- **Registro**: `NotificationLog`.

### Marketplace (clientes)
#### ORDER_SHIPPED / ORDER_DELIVERED / ORDER_CANCELLED / ORDER_READY_FOR_PICKUP
- **Disparo**: Dos capas: (1) `notify_order_status_change` (task) envía notificación básica con `order_id`, `tracking_number`, `delivered_at`, `status` (`marketplace/tasks.py:11-47`); (2) `MarketplaceNotificationService.send_order_status_update` enriquece el contexto (tracking, fecha estimada, dirección) y usa alta prioridad (`marketplace/services/notification_service.py:20-70`). Ambos caminos terminan en `NotificationService`.
- **Contexto**: Ver `marketplace/services/notification_service.py:36-57` para los campos dinámicos.
- **Destinatario**: Usuario dueño de la orden. WhatsApp→Email (SID placeholders `notifications/twilio_templates.py:107-130`).
- **Registro**: `NotificationLog`.

#### ORDER_RETURN_REQUESTED / ORDER_RETURN_APPROVED *(pendiente)*
- **Definición**: Están en el mapa Twilio (`notifications/twilio_templates.py:133-144`) y la task `ReturnService.request_return` intenta invocar `notify_order_status_change` con `RETURN_REQUESTED`, pero `event_map` no contempla ese estado (`marketplace/tasks.py:21-31`). No existe llamada explícita a `NotificationService` con estos códigos, por lo que nunca se generan.
- **Acción recomendada**: Añadir los estados al `event_map` y a `MarketplaceNotificationService` si se desea usarlos.

#### ORDER_CREDIT_ISSUED
- **Disparo**: `ReturnService.process_return` crea créditos y luego llama a `MarketplaceNotificationService.send_return_processed` (`marketplace/services/return_service.py:124-145`).
- **Contexto**: `user_name`, `credit_amount`, `reason`, `order_id` (`marketplace/services/notification_service.py:131-140`).
- **Destinatario**: Cliente de la orden; WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:145-150`).
- **Registro**: `NotificationLog` y, adicionalmente, hay `AuditLog` de la devolución (`marketplace/services/return_service.py:147-159`).

### Marketplace (admin)
#### STOCK_LOW_ALERT
- **Disparo**: `MarketplaceNotificationService.send_low_stock_alert` cuando la lógica de inventario detecta variantes bajo mínimo (`marketplace/services/notification_service.py:71-118`). Se invoca desde `InventoryService` (no en este diff) cuando se prenden alertas.
- **Contexto**: Cadena multilinea `items_list` con productos bajos en stock.
- **Destinatario**: Primer admin con teléfono configurado en `BotConfiguration` (o cualquier admin activo como fallback); WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:152-158`).
- **Registro**: `NotificationLog`.

### Usuarios bloqueados
#### USER_FLAGGED_NON_GRATA
- **Disparos**:
  - `FlagNonGrataView.perform_update` notifica al **usuario bloqueado** de su estatus (`users/views/admin_views.py:33-130`).
  - `send_non_grata_alert_to_admins` se usa cuando un número marcado intenta registrarse y se alerta al **admin** (`users/tasks.py:15-77`).
- **Contextos**: Para el cliente: `phone_number`, `notes`. Para admins: `user_name`, `user_email`, `user_phone`, `flag_reason`, `action_taken`, `admin_url` (`users/tasks.py:53-61`).
- **Canales/destinatarios**: Cliente (WhatsApp+Email) y admin (WhatsApp critical, ignora quiet hours) usando el mismo `event_code` (`notifications/twilio_templates.py:160-166`).
- **Registro**: `NotificationLog` (dos entradas separadas, una por cada destinatario). Además se crean `AdminNotification` y `AuditLog` en la vista (`users/views/admin_views.py:62-76`).

### Bot / Atención humana
#### BOT_HANDOFF_CREATED
- **Disparo**: `HandoffNotificationService.send_handoff_notification` es llamado desde múltiples puntos cuando el bot crea un `HumanHandoffRequest`: `bot/tasks/process_message.py:183-195`, `bot/services_shared.py:312`, `bot/views/webhook/bot_webhook.py:438`.
- **Contexto**: Métricas del lead (`score_emoji`, `client_score`, `client_name`, `client_phone`, `warning_text`, `escalation_message`, `admin_url`) (`bot/notifications.py:56-78`).
- **Destinatarios**: Admin/staff con teléfono configurado. WhatsApp→Email (SID placeholder `notifications/twilio_templates.py:168-174`).
- **Registro**: `NotificationLog`.

#### BOT_HANDOFF_EXPIRED
- **Disparo**: `check_handoff_timeout` programa un timeout de 5 minutos y, si el handoff sigue en estado `PENDING`, lo marca como `EXPIRED`, genera un mensaje automático y llama a `HandoffNotificationService.send_expired_handoff_notification` (`bot/tasks/cleanup.py:152-192`, `bot/notifications.py:245-297`).
- **Contexto**: `handoff_id`, `client_name`, `created_at`, `admin_url`.
- **Destinatarios**: Admin/staff; prioridad `critical` para ignorar quiet hours (`bot/notifications.py:289-295`).
- **Registro**: `NotificationLog`.

#### BOT_HANDOFF_REPLY *(evento adicional #27)*
- **Disparo**: Cuando un miembro del staff responde desde la vista de handoff humano, `_send_client_notification` avisa al cliente (`bot/views/handoff_api.py:224-290`).
- **Contexto**: `message`, `staff_name`, `handoff_id`, `recipient_name`.
- **Destinatario**: Cliente asociado al handoff; prioriza WhatsApp. **No hay entrada en `TWILIO_TEMPLATE_MAP`**, aunque la migración `0006_add_bot_handoff_reply_template` sí creó una plantilla WhatsApp (`notifications/migrations/0006_add_bot_handoff_reply_template.py:7-34`). Esto explica por qué teníamos 27 eventos.
- **Registro**: `NotificationLog` + `HumanMessage` setea `delivery_channel='notification_service'` (`bot/views/handoff_api.py:275-279`).

### Bot / Seguridad
#### BOT_SECURITY_ALERT
- **Disparo**: `SuspiciousActivityAlertService.send_critical_activity_alert` corre al registrar una actividad con severidad CRITICAL via `record_activity` (`bot/suspicious_activity_detector/actions.py:11-66`).
- **Contexto**: `alert_type`, `user_identifier`, `alert_detail`, `timestamp` (`bot/alerts.py:90-103`).
- **Destinatarios**: Admin con teléfono configurado; prioridad critical + email masivo (`bot/alerts.py:98-122`).
- **Registro**: `NotificationLog`.

#### BOT_AUTO_BLOCK
- **Disparo**: Cuando una IP supera el umbral configurado, `AutoBlockService.check_and_auto_block` crea la entrada en `IPBlocklist` y llama a `SuspiciousActivityAlertService.send_auto_block_notification` (`bot/alerts.py:287-360` + `bot/alerts.py:134-198`).
- **Contexto**: `user_identifier` (IP), `block_reason`, `timestamp`, `admin_url`.
- **Destinatarios**: Admin; prioridad critical.
- **Registro**: `NotificationLog` y registro adicional en `IPBlocklist`.

## Observaciones relevantes
1. **Eventos sin disparador**: `VIP_LOYALTY_MILESTONE`, `ORDER_RETURN_REQUESTED` y `ORDER_RETURN_APPROVED` están configurados solo a nivel de plantilla. Si son necesarios, hay que añadir llamadas a `NotificationService` (recomendado hacerlo en las tareas de loyalty y devoluciones respectivamente).
2. **Content SIDs pendientes**: Excepto para `APPOINTMENT_REMINDER_24H`, todos los SIDs siguen en modo placeholder (`notifications/twilio_templates.py`). Eso implica que WhatsApp usa mensajes dinámicos sujetos a la ventana de 24 h. Registrar los SIDs reales habilitaría plantillas aprobadas.
3. **Evento adicional**: `BOT_HANDOFF_REPLY` eleva el total a 27 rutas. Conviene añadirlo al mapa Twilio para mantener sincronizado el inventario y aprovechar `is_template_configured()`.
4. **Persistencia centralizada**: Cualquier auditoría o dashboard puede consultar `NotificationLog` filtrando por `event_code` y `status` (`notifications/models.py:147-179`). Se recomienda aprovechar `metadata.context` para enriquecer reportes (p.ej., phone_number se promociona a metadata de primer nivel en `notifications/services.py:189-191`).
