============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\joshe\Desktop\Zenz\studiozens\venv\Scripts\python.exe
cachedir: .pytest_cache
django: version: 5.2.3, settings: studiozens.settings (from ini)
rootdir: C:\Users\joshe\Desktop\Zenz\studiozens
configfile: pytest.ini
plugins: anyio-4.11.0, cov-7.0.0, django-4.11.1, mock-3.15.1
collecting ... collected 134 items

finances/tests/test_additional.py::PaymentServiceUtilsTests::test_build_customer_data_uses_user_info PASSED [  0%]
finances/tests/test_additional.py::PaymentServiceUtilsTests::test_build_tax_payload_includes_vat_and_consumption PASSED [  1%]
finances/tests/test_additional.py::PaymentServiceUtilsTests::test_create_pse_payment_updates_fields PASSED [  2%]
finances/tests/test_additional.py::PaymentServiceUtilsTests::test_poll_pending_payment_sets_timeout_without_transaction_id PASSED [  2%]
finances/tests/test_additional.py::WebhookServiceTests::test_process_payout_update_updates_commission_ledger PASSED [  3%]
finances/tests/test_additional.py::WebhookServiceTests::test_process_token_update_creates_payment_token PASSED [  4%]
finances/tests/test_additional.py::ViewsTests::test_pse_financial_institutions_http_error PASSED [  5%]
finances/tests/test_additional.py::ViewsTests::test_webhook_view_unhandled_event PASSED [  5%]
finances/tests/test_additional.py::SubscriptionsTests::test_extend_membership_invalid_months PASSED [  6%]
finances/tests/test_additional.py::SubscriptionsTests::test_extend_membership_sets_dates PASSED [  7%]
finances/tests/test_additional.py::SubscriptionsTests::test_fulfill_subscription_creates_log PASSED [  8%]
finances/tests/test_additional.py::TasksTests::test_check_pending_payments_counts PASSED [  8%]
finances/tests/test_additional.py::TasksTests::test_cleanup_old_webhook_events_deletes PASSED [  9%]
finances/tests/test_additional.py::GatewayCircuitTests::test_create_transaction_circuit_open_raises PASSED [ 10%]
finances/tests/test_additional.py::GatewayCircuitTests::test_fetch_transaction_circuit_open_returns_none PASSED [ 11%]
finances/tests/test_commissions.py::DeveloperCommissionStatusViewTests::test_status_includes_wompi_balance PASSED [ 11%]
finances/tests/test_commissions.py::CommissionLedgerServiceTests::test_build_integrity_signature PASSED [ 12%]
finances/tests/test_commissions.py::CommissionLedgerServiceTests::test_mark_failed_nsf_updates_pending_entries PASSED [ 13%]
finances/tests/test_commissions.py::CommissionLedgerServiceTests::test_negative_amount_is_invalid PASSED [ 14%]
finances/tests/test_commissions.py::DeveloperPayoutTaskTests::test_run_developer_payout_delegates_to_service PASSED [ 14%]
finances/tests/test_disbursement_client.py::WompiDisbursementClientTests::test_create_payout_missing_base_url PASSED [ 15%]
finances/tests/test_disbursement_client.py::WompiDisbursementClientTests::test_create_payout_returns_transfer_id PASSED [ 16%]
finances/tests/test_disbursement_client.py::WompiDisbursementClientTests::test_create_payout_without_transfer_id_raises PASSED [ 17%]
finances/tests/test_disbursement_client.py::WompiDisbursementClientTests::test_get_available_balance_returns_decimal PASSED [ 17%]
finances/tests/test_disbursement_client.py::WompiDisbursementClientTests::test_get_available_balance_timeout_raises PASSED [ 18%]
finances/tests/test_gateway.py::WompiGatewayTests::test_build_integrity_signature_uses_key PASSED [ 19%]
finances/tests/test_gateway.py::WompiGatewayTests::test_build_integrity_signature_with_expiration_time PASSED [ 20%]
finances/tests/test_gateway.py::WompiGatewayTests::test_create_daviplata_transaction PASSED [ 20%]
finances/tests/test_gateway.py::WompiGatewayTests::test_create_nequi_transaction PASSED [ 21%]
finances/tests/test_gateway.py::WompiGatewayTests::test_create_pse_transaction PASSED [ 22%]
finances/tests/test_gateway.py::WompiGatewayTests::test_get_pse_financial_institutions PASSED [ 23%]
finances/tests/test_gateway.py::WompiGatewayTests::test_resolve_acceptance_token_fetches_and_caches PASSED [ 23%]
finances/tests/test_gateway.py::WompiGatewayTests::test_tokenize_card PASSED [ 24%]
finances/tests/test_gateway.py::WompiGatewayTests::test_tokenize_nequi PASSED [ 25%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_circuit_breaker PASSED [ 26%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_max_retries PASSED [ 26%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_success PASSED [ 27%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_timeout_then_success PASSED [ 28%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_create_payment_source_error PASSED [ 29%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_create_payment_source_from_token PASSED [ 29%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_tokenize_card_error PASSED [ 30%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_tokenize_card_success PASSED [ 31%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_apply_gateway_status_declined PASSED [ 32%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_apply_gateway_status_sets_transaction_id_on_approved PASSED [ 32%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_charge_recurrence_token_amount_zero_raises PASSED [ 33%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_charge_recurrence_token_missing_email_declines PASSED [ 34%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_charge_recurrence_token_missing_token_raises PASSED [ 35%]
finances/tests/test_more.py::PaymentServiceEdgeTests::test_charge_recurrence_token_missing_user_raises PASSED [ 35%]
finances/tests/test_more.py::GatewayEdgeTests::test_build_integrity_signature_without_key_returns_none PASSED [ 36%]
finances/tests/test_more.py::GatewayEdgeTests::test_fetch_transaction_missing_base_or_reference_returns_none PASSED [ 37%]
finances/tests/test_more.py::GatewayEdgeTests::test_resolve_acceptance_token_missing_config_returns_none PASSED [ 38%]
finances/tests/test_more.py::WebhookViewTests::test_webhook_view_handles_transaction_updated PASSED [ 38%]
finances/tests/test_more.py::WebhookViewTests::test_webhook_view_returns_400_on_value_error PASSED [ 39%]
finances/tests/test_more.py::DisbursementClientTests::test_create_payout_missing_destination_raises PASSED [ 40%]
finances/tests/test_more.py::DisbursementClientTests::test_get_available_balance_invalid_json_raises PASSED [ 41%]
finances/tests/test_more.py::DisbursementClientTests::test_request_with_retry_retries_timeout PASSED [ 41%]
finances/tests/test_more.py::DeveloperCommissionTests::test_evaluate_payout_below_threshold PASSED [ 42%]
finances/tests/test_more.py::DeveloperCommissionTests::test_register_commission_returns_none_without_amount PASSED [ 43%]
finances/tests/test_more.py::SubscriptionTasksTests::test_downgrade_expired_vips_changes_role PASSED [ 44%]
finances/tests/test_more.py::SubscriptionTasksTests::test_process_recurring_subscriptions_price_not_configured PASSED [ 44%]
finances/tests/test_more.py::SubscriptionTasksTests::test_run_developer_payout_task PASSED [ 45%]
finances/tests/test_more.py::InitiateViewsTests::test_initiate_appointment_payment_requires_pending_payment PASSED [ 46%]
finances/tests/test_more.py::InitiateViewsTests::test_initiate_package_purchase_invalid_payload PASSED [ 47%]
finances/tests/test_more.py::InitiateViewsTests::test_initiate_vip_subscription_view_missing_price_returns_500 PASSED [ 47%]
finances/tests/test_payments.py::PaymentServiceTest::test_charge_recurrence_token_circuit_open PASSED [ 48%]
finances/tests/test_payments.py::PaymentServiceTest::test_charge_recurrence_token_declined PASSED [ 49%]
finances/tests/test_payments.py::PaymentServiceTest::test_charge_recurrence_token_error PASSED [ 50%]
finances/tests/test_payments.py::PaymentServiceTest::test_charge_recurrence_token_uses_signature_object PASSED [ 50%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_build_customer_data PASSED [ 51%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_build_tax_payload PASSED [ 52%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_charge_recurrence_token_validations PASSED [ 52%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_bancolombia_transfer_payment PASSED [ 53%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_daviplata_payment PASSED [ 54%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_nequi_payment PASSED [ 55%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_pse_payment PASSED [ 55%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_pse_payment_invalid_status PASSED [ 56%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_send_payment_status_notification PASSED [ 57%]
finances/tests/test_serializers.py::CommissionLedgerSerializerTest::test_get_pending_amount PASSED [ 58%]
finances/tests/test_serializers.py::PaymentSerializerTest::test_payment_serializer_fields PASSED [ 58%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_invalid_payment PASSED [ 59%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_invalid_user PASSED [ 60%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_valid_data PASSED [ 61%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_create_sets_default_remaining PASSED [ 61%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_validate_remaining_greater_than_initial PASSED [ 62%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_validate_remaining_negative PASSED [ 63%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_create_payout_error PASSED [ 64%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_create_payout_success PASSED [ 64%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_get_available_balance_error PASSED [ 65%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_get_available_balance_success PASSED [ 66%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_below_threshold PASSED [ 67%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_success PASSED [ 67%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_get_developer_debt PASSED [ 68%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_register_commission PASSED [ 69%]
finances/tests/test_services.py::FinancialAdjustmentServiceTest::test_create_adjustment_credit PASSED [ 70%]
finances/tests/test_services.py::FinancialAdjustmentServiceTest::test_create_adjustment_limit_exceeded PASSED [ 70%]
finances/tests/test_services.py::CreditManagementServiceTest::test_apply_cancellation_penalty PASSED [ 71%]
finances/tests/test_services.py::CreditManagementServiceTest::test_issue_credit_from_appointment PASSED [ 72%]
finances/tests/test_tasks.py::FinancesTasksTest::test_check_pending_payments PASSED [ 73%]
finances/tests/test_tasks.py::FinancesTasksTest::test_cleanup_old_webhook_events PASSED [ 73%]
finances/tests/test_tasks.py::FinancesTasksTest::test_downgrade_expired_vips PASSED [ 74%]
finances/tests/test_tasks.py::FinancesTasksTest::test_process_recurring_subscriptions_failure PASSED [ 75%]
finances/tests/test_tasks.py::FinancesTasksTest::test_process_recurring_subscriptions_success PASSED [ 76%]
finances/tests/test_tasks.py::FinancesTasksTest::test_reconcile_recent_payments PASSED [ 76%]
finances/tests/test_views.py::PSEFinancialInstitutionsViewTest::test_propagates_status_code_when_gateway_returns_tuple PASSED [ 77%]
finances/tests/test_views.py::PSEFinancialInstitutionsViewTest::test_returns_institutions_when_gateway_returns_list PASSED [ 78%]
finances/tests/test_views.py::InitiateAppointmentPaymentViewTest::test_initiate_payment_success PASSED [ 79%]
finances/tests/test_views.py::InitiateVipSubscriptionViewTest::test_initiate_vip_success PASSED [ 79%]
finances/tests/test_views.py::InitiatePackagePurchaseViewTest::test_initiate_package_success PASSED [ 80%]
finances/tests/test_views.py::WompiWebhookViewTest::test_webhook_invalid_signature PASSED [ 81%]
finances/tests/test_views.py::WompiWebhookViewTest::test_webhook_success PASSED [ 82%]
finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_date_range PASSED [ 82%]
finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_status PASSED [ 83%]
finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_exception_handling PASSED [ 84%]
finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_success PASSED [ 85%]
finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_create_credit_computes_status PASSED [ 85%]
finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_update_credit_recomputes_status PASSED [ 86%]
finances/tests/test_webhooks.py::WompiWebhookServiceTest::test_webhook_rejects_amount_mismatch PASSED [ 87%]
finances/tests/test_webhooks.py::WompiWebhookServiceTest::test_webhook_rejects_stale_timestamp PASSED [ 88%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_approved PASSED [ 88%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_declined PASSED [ 89%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_missing_id PASSED [ 90%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_token_update_missing_id PASSED [ 91%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_token_update_success PASSED [ 91%]
finances/tests/test_urls.py::TestFinancesURLs::test_commission_ledger_list_url PASSED [ 92%]
finances/tests/test_urls.py::TestFinancesURLs::test_commission_ledger_status_url PASSED [ 93%]
finances/tests/test_urls.py::TestFinancesURLs::test_create_bancolombia_transfer_payment_url PASSED [ 94%]
finances/tests/test_urls.py::TestFinancesURLs::test_create_daviplata_payment_url PASSED [ 94%]
finances/tests/test_urls.py::TestFinancesURLs::test_create_nequi_payment_url PASSED [ 95%]
finances/tests/test_urls.py::TestFinancesURLs::test_create_pse_payment_url PASSED [ 96%]
finances/tests/test_urls.py::TestFinancesURLs::test_initiate_appointment_payment_url PASSED [ 97%]
finances/tests/test_urls.py::TestFinancesURLs::test_initiate_package_purchase_url PASSED [ 97%]
finances/tests/test_urls.py::TestFinancesURLs::test_initiate_vip_subscription_url PASSED [ 98%]
finances/tests/test_urls.py::TestFinancesURLs::test_pse_banks_url PASSED [ 99%]
finances/tests/test_urls.py::TestFinancesURLs::test_wompi_webhook_url PASSED [100%]

=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.3-final-0 _______________

Name                        Stmts   Miss  Cover   Missing
---------------------------------------------------------
finances\admin.py              50      0   100%
finances\apps.py               14      4    71%   19-29
finances\gateway.py           353    155    56%   61, 64-67, 94-97, 105, 117-138, 204, 208-214, 218, 222, 233-255, 260-286, 292, 310-312, 358, 389, 392, 395-401, 404, 407, 425, 434-439, 497, 500, 503-509, 512, 515, 577, 580, 583-589, 592, 595, 630-677, 706, 749, 802, 817-819, 840-855
finances\models.py            180     21    88%   150, 164, 218, 256-258, 261, 283, 305, 358, 368, 374-382, 452
finances\payments.py          429    143    67%   35, 52, 65-66, 68-69, 72, 77-78, 84-88, 101-107, 122, 128-144, 170-171, 201, 205, 278, 290, 312-321, 329-370, 378-441, 446-452, 462-480, 485-497, 501, 523, 590, 593, 642, 644, 689, 691, 727, 745, 747, 751, 765-767, 774-775, 778, 798, 807-808, 818-824, 828, 833, 839, 853, 860, 866, 872-878
finances\serializers.py        68      1    99%   90
finances\services.py          342     78    77%   75, 84-85, 94, 127-129, 133-134, 136, 138, 153, 169, 171, 187-188, 193, 200, 217, 222, 231, 252-255, 262-263, 276-281, 285-292, 296-301, 308, 324, 327, 375-378, 385-414, 419-422, 449, 470, 505, 517, 526, 530, 561, 573-574, 595, 598-599, 605
finances\subscriptions.py      41      3    93%   27, 34, 67
finances\tasks.py             116     13    89%   53, 128-144, 168-173, 193-194, 236-237
finances\urls.py                6      0   100%
finances\views.py             222     56    75%   129-130, 149, 156-157, 202-203, 205-206, 212-213, 232, 314-317, 320, 328-354, 362-377, 385-400, 408-423, 438, 442
finances\webhooks.py          232     84    64%   48-51, 78-81, 88-92, 97-99, 123-124, 136-137, 182-184, 201-309
legal\admin.py                 14      0   100%
legal\apps.py                   4      0   100%
legal\middleware.py            22     11    50%   29-61
legal\models.py                71     10    86%   41-44, 48-55, 98, 102-103
legal\permissions.py           26      4    85%   19, 28, 32-33
legal\serializers.py           52      2    96%   90, 93
legal\tests.py                108      2    98%   180-181
legal\urls.py                   8      0   100%
legal\views.py                 68     28    59%   17-19, 34-48, 76, 91-98, 107-110
---------------------------------------------------------
TOTAL                        2426    615    75%
====================== 134 passed, 5 warnings in 16.21s =======================
