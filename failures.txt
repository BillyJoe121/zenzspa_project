============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\joshe\Desktop\Zenz\studiozens\venv\Scripts\python.exe
cachedir: .pytest_cache
django: version: 5.2.3, settings: studiozens.settings (from ini)
rootdir: C:\Users\joshe\Desktop\Zenz\studiozens
configfile: pytest.ini
plugins: anyio-4.11.0, cov-7.0.0, django-4.11.1, mock-3.15.1
collecting ... collected 60 items

finances/tests/test_serializers.py::CommissionLedgerSerializerTest::test_get_pending_amount FAILED [  1%]
finances/tests/test_serializers.py::PaymentSerializerTest::test_payment_serializer_fields FAILED [  3%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_invalid_payment PASSED [  5%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_invalid_user PASSED [  6%]
finances/tests/test_serializers.py::FinancialAdjustmentCreateSerializerTest::test_valid_data PASSED [  8%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_create_sets_default_remaining FAILED [ 10%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_validate_remaining_greater_than_initial PASSED [ 11%]
finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_validate_remaining_negative PASSED [ 13%]
finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_date_range FAILED [ 15%]
finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_status FAILED [ 16%]
finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_exception_handling FAILED [ 18%]
finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_success FAILED [ 20%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_bancolombia_payment_success PASSED [ 21%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_daviplata_payment_success PASSED [ 23%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_nequi_payment_missing_phone PASSED [ 25%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_nequi_payment_success PASSED [ 26%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_pse_payment_missing_fields PASSED [ 28%]
finances/tests/test_views_extended.py::CreatePaymentViewsTest::test_create_pse_payment_success PASSED [ 30%]
finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_create_credit_computes_status FAILED [ 31%]
finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_update_credit_recomputes_status FAILED [ 33%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_build_customer_data PASSED [ 35%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_build_tax_payload PASSED [ 36%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_charge_recurrence_token_validations PASSED [ 38%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_bancolombia_transfer_payment PASSED [ 40%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_daviplata_payment PASSED [ 41%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_nequi_payment PASSED [ 43%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_pse_payment PASSED [ 45%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_create_pse_payment_invalid_status PASSED [ 46%]
finances/tests/test_payments_extended.py::PaymentServiceExtendedTest::test_send_payment_status_notification PASSED [ 48%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_approved PASSED [ 50%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_declined PASSED [ 51%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_payout_update_missing_id PASSED [ 53%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_token_update_missing_id PASSED [ 55%]
finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_token_update_success FAILED [ 56%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_circuit_breaker PASSED [ 58%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_max_retries PASSED [ 60%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_success PASSED [ 61%]
finances/tests/test_gateway_extended.py::WompiGatewayExtendedTest::test_request_with_retry_timeout_then_success PASSED [ 63%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_create_payment_source_error PASSED [ 65%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_create_payment_source_from_token PASSED [ 66%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_tokenize_card_error PASSED [ 68%]
finances/tests/test_gateway_extended.py::WompiPaymentClientExtendedTest::test_tokenize_card_success PASSED [ 70%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_create_payout_error PASSED [ 71%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_create_payout_success PASSED [ 73%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_get_available_balance_error PASSED [ 75%]
finances/tests/test_services.py::WompiDisbursementClientTest::test_get_available_balance_success PASSED [ 76%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_below_threshold FAILED [ 78%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_success FAILED [ 80%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_get_developer_debt FAILED [ 81%]
finances/tests/test_services.py::DeveloperCommissionServiceTest::test_register_commission PASSED [ 83%]
finances/tests/test_services.py::FinancialAdjustmentServiceTest::test_create_adjustment_credit PASSED [ 85%]
finances/tests/test_services.py::FinancialAdjustmentServiceTest::test_create_adjustment_limit_exceeded PASSED [ 86%]
finances/tests/test_services.py::CreditManagementServiceTest::test_apply_cancellation_penalty PASSED [ 88%]
finances/tests/test_services.py::CreditManagementServiceTest::test_issue_credit_from_appointment PASSED [ 90%]
finances/tests/test_tasks.py::FinancesTasksTest::test_check_pending_payments PASSED [ 91%]
finances/tests/test_tasks.py::FinancesTasksTest::test_cleanup_old_webhook_events PASSED [ 93%]
finances/tests/test_tasks.py::FinancesTasksTest::test_downgrade_expired_vips PASSED [ 95%]
finances/tests/test_tasks.py::FinancesTasksTest::test_process_recurring_subscriptions_failure PASSED [ 96%]
finances/tests/test_tasks.py::FinancesTasksTest::test_process_recurring_subscriptions_success PASSED [ 98%]
finances/tests/test_tasks.py::FinancesTasksTest::test_reconcile_recent_payments PASSED [100%]

================================== FAILURES ===================================
___________ CommissionLedgerSerializerTest.test_get_pending_amount ____________
finances\tests\test_serializers.py:15: in test_get_pending_amount
    ledger = baker.make(CommissionLedger, amount=1000, paid_amount=200)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\model_bakery\baker.py:147: in make
    return baker.make(
venv\Lib\site-packages\model_bakery\baker.py:406: in make
    return self._make(**params)
           ^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\model_bakery\baker.py:482: in _make
    instance = self.instance(
venv\Lib\site-packages\model_bakery\baker.py:535: in instance
    instance.save(**_save_kwargs)
finances\models.py:457: in save
    self.amount = self.amount.quantize(Decimal("0.01"))
                  ^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'quantize'
---------------------------- Captured stdout setup ----------------------------
Operations to perform:
  Synchronize unmigrated apps: analytics, corsheaders, csp, django_prometheus, messages, rest_framework, rest_framework_simplejwt, simple_history, staticfiles
  Apply all migrations: admin, auth, bot, contenttypes, core, finances, legal, marketplace, notifications, profiles, sessions, spa, token_blacklist, users
Synchronizing apps without migrations:
  Creating tables...
    Running deferred SQL...
Running migrations:
  No migrations to apply.
---------------------------- Captured stderr setup ----------------------------
Using existing test database for alias 'default' ('test_studiozens')...
____________ PaymentSerializerTest.test_payment_serializer_fields _____________
finances\tests\test_serializers.py:24: in test_payment_serializer_fields
    self.assertEqual(set(serializer.data.keys()), {
E   AssertionError: Items in the first set but not the second:
E   'customer_legal_id'
E   'payment_method_type'
E   'used_credit'
E   'order'
E   'tax_vat_in_cents'
E   'tax_consumption_in_cents'
E   'payment_method_data'
E   'customer_legal_id_type'
E   Items in the second set but not the first:
E   'package'
E   'subscription_log'
_____ ClientCreditAdminSerializerTest.test_create_sets_default_remaining ______
finances\tests\test_serializers.py:101: in test_create_sets_default_remaining
    self.assertTrue(serializer.is_valid())
E   AssertionError: False is not true
___________ CommissionLedgerListViewTest.test_filter_by_date_range ____________
finances\tests\test_views_extended.py:28: in test_filter_by_date_range
    self.assertEqual(response.status_code, 200)
E   AssertionError: 403 != 200
---------------------------- Captured stderr call -----------------------------
[DEBUG] 
def notify_order_status_change(order_id, new_status):
    return 1

[DEBUG] 
def release_expired_order_reservations():
    return 1

[DEBUG] 
def cleanup_expired_carts():
    return 1

[WARNING] Forbidden: /api/v1/finances/commissions/
------------------------------ Captured log call ------------------------------
DEBUG    celery.utils.functional:functional.py:335 
def notify_order_status_change(order_id, new_status):
    return 1

DEBUG    celery.utils.functional:functional.py:335 
def release_expired_order_reservations():
    return 1

DEBUG    celery.utils.functional:functional.py:335 
def cleanup_expired_carts():
    return 1

WARNING  django.request:log.py:253 Forbidden: /api/v1/finances/commissions/
_____________ CommissionLedgerListViewTest.test_filter_by_status ______________
finances\tests\test_views_extended.py:21: in test_filter_by_status
    self.assertEqual(response.status_code, 200)
E   AssertionError: 403 != 200
---------------------------- Captured stderr call -----------------------------
[WARNING] Forbidden: /api/v1/finances/commissions/
------------------------------ Captured log call ------------------------------
WARNING  django.request:log.py:253 Forbidden: /api/v1/finances/commissions/
____ DeveloperCommissionStatusViewTest.test_get_status_exception_handling _____
finances\tests\test_views_extended.py:55: in test_get_status_exception_handling
    url = reverse("developer-commission-status")
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\base.py:98: in reverse
    resolved_url = resolver._reverse_with_prefix(view, prefix, *args, **kwargs)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\resolvers.py:831: in _reverse_with_prefix
    raise NoReverseMatch(msg)
E   django.urls.exceptions.NoReverseMatch: Reverse for 'developer-commission-status' not found. 'developer-commission-status' is not a valid view function or pattern name.
__________ DeveloperCommissionStatusViewTest.test_get_status_success __________
finances\tests\test_views_extended.py:44: in test_get_status_success
    url = reverse("developer-commission-status")
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\base.py:98: in reverse
    resolved_url = resolver._reverse_with_prefix(view, prefix, *args, **kwargs)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\resolvers.py:831: in _reverse_with_prefix
    raise NoReverseMatch(msg)
E   django.urls.exceptions.NoReverseMatch: Reverse for 'developer-commission-status' not found. 'developer-commission-status' is not a valid view function or pattern name.
_______ ClientCreditAdminViewSetTest.test_create_credit_computes_status _______
finances\tests\test_views_extended.py:121: in test_create_credit_computes_status
    url = reverse("client-credit-list")
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\base.py:98: in reverse
    resolved_url = resolver._reverse_with_prefix(view, prefix, *args, **kwargs)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\resolvers.py:831: in _reverse_with_prefix
    raise NoReverseMatch(msg)
E   django.urls.exceptions.NoReverseMatch: Reverse for 'client-credit-list' not found. 'client-credit-list' is not a valid view function or pattern name.
______ ClientCreditAdminViewSetTest.test_update_credit_recomputes_status ______
finances\tests\test_views_extended.py:132: in test_update_credit_recomputes_status
    url = reverse("client-credit-detail", args=[credit.id])
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\base.py:98: in reverse
    resolved_url = resolver._reverse_with_prefix(view, prefix, *args, **kwargs)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\urls\resolvers.py:831: in _reverse_with_prefix
    raise NoReverseMatch(msg)
E   django.urls.exceptions.NoReverseMatch: Reverse for 'client-credit-detail' not found. 'client-credit-detail' is not a valid view function or pattern name.
______ WompiWebhookServiceExtendedTest.test_process_token_update_success ______
finances\tests\test_webhooks_extended.py:32: in test_process_token_update_success
    self.assertTrue(PaymentToken.objects.filter(token_secret="tok_123").exists())
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\query.py:1493: in filter
    return self._filter_or_exclude(False, args, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\query.py:1511: in _filter_or_exclude
    clone._filter_or_exclude_inplace(negate, args, kwargs)
venv\Lib\site-packages\django\db\models\query.py:1518: in _filter_or_exclude_inplace
    self._query.add_q(Q(*args, **kwargs))
venv\Lib\site-packages\django\db\models\sql\query.py:1646: in add_q
    clause, _ = self._add_q(q_object, can_reuse)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\sql\query.py:1678: in _add_q
    child_clause, needed_inner = self.build_filter(
venv\Lib\site-packages\django\db\models\sql\query.py:1588: in build_filter
    condition = self.build_lookup(lookups, col, value)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\sql\query.py:1415: in build_lookup
    lookup = lookup_class(lhs, rhs)
             ^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\django\db\models\lookups.py:38: in __init__
    self.rhs = self.get_prep_lookup()
               ^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fernet_fields\fields.py:91: in get_prep_lookup
    raise FieldError(
E   django.core.exceptions.FieldError: EncryptedTextField 'exact' does not support lookups
---------------------------- Captured stderr call -----------------------------
[INFO] [PAYMENT-SUCCESS] Evento de token procesado (event=nequi_token.updated, token=****_123, status=APPROVED)
------------------------------ Captured log call ------------------------------
INFO     finances.webhooks:webhooks.py:386 [PAYMENT-SUCCESS] Evento de token procesado (event=nequi_token.updated, token=****_123, status=APPROVED)
_____ DeveloperCommissionServiceTest.test_evaluate_payout_below_threshold _____
finances\tests\test_services.py:81: in test_evaluate_payout_below_threshold
    baker.make(CommissionLedger, amount=100, paid_amount=0, status=CommissionLedger.Status.PENDING)
venv\Lib\site-packages\model_bakery\baker.py:147: in make
    return baker.make(
venv\Lib\site-packages\model_bakery\baker.py:406: in make
    return self._make(**params)
           ^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\model_bakery\baker.py:482: in _make
    instance = self.instance(
venv\Lib\site-packages\model_bakery\baker.py:535: in instance
    instance.save(**_save_kwargs)
finances\models.py:457: in save
    self.amount = self.amount.quantize(Decimal("0.01"))
                  ^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'quantize'
---------------------------- Captured stderr call -----------------------------
[WARNING] GlobalSettings modificado: developer_commission_percentage: 5.00 -> 10
------------------------------ Captured log call ------------------------------
WARNING  core.models.settings:settings.py:253 GlobalSettings modificado: developer_commission_percentage: 5.00 -> 10
_________ DeveloperCommissionServiceTest.test_evaluate_payout_success _________
finances\tests\test_services.py:87: in test_evaluate_payout_success
    baker.make(CommissionLedger, amount=1000, paid_amount=0, status=CommissionLedger.Status.PENDING)
venv\Lib\site-packages\model_bakery\baker.py:147: in make
    return baker.make(
venv\Lib\site-packages\model_bakery\baker.py:406: in make
    return self._make(**params)
           ^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\model_bakery\baker.py:482: in _make
    instance = self.instance(
venv\Lib\site-packages\model_bakery\baker.py:535: in instance
    instance.save(**_save_kwargs)
finances\models.py:457: in save
    self.amount = self.amount.quantize(Decimal("0.01"))
                  ^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'quantize'
___________ DeveloperCommissionServiceTest.test_get_developer_debt ____________
finances\tests\test_services.py:74: in test_get_developer_debt
    baker.make(CommissionLedger, amount=100, paid_amount=0, status=CommissionLedger.Status.PENDING)
venv\Lib\site-packages\model_bakery\baker.py:147: in make
    return baker.make(
venv\Lib\site-packages\model_bakery\baker.py:406: in make
    return self._make(**params)
           ^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\model_bakery\baker.py:482: in _make
    instance = self.instance(
venv\Lib\site-packages\model_bakery\baker.py:535: in instance
    instance.save(**_save_kwargs)
finances\models.py:457: in save
    self.amount = self.amount.quantize(Decimal("0.01"))
                  ^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'quantize'
=========================== short test summary info ===========================
FAILED finances/tests/test_serializers.py::CommissionLedgerSerializerTest::test_get_pending_amount - AttributeError: 'int' object has no attribute 'quantize'
FAILED finances/tests/test_serializers.py::PaymentSerializerTest::test_payment_serializer_fields - AssertionError: Items in the first set but not the second:
'customer_legal_id'
'payment_method_type'
'used_credit'
'order'
'tax_vat_in_cents'
'tax_consumption_in_cents'
'payment_method_data'
'customer_legal_id_type'
Items in the second set but not the first:
'package'
'subscription_log'
FAILED finances/tests/test_serializers.py::ClientCreditAdminSerializerTest::test_create_sets_default_remaining - AssertionError: False is not true
FAILED finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_date_range - AssertionError: 403 != 200
FAILED finances/tests/test_views_extended.py::CommissionLedgerListViewTest::test_filter_by_status - AssertionError: 403 != 200
FAILED finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_exception_handling - django.urls.exceptions.NoReverseMatch: Reverse for 'developer-commission-status' not found. 'developer-commission-status' is not a valid view function or pattern name.
FAILED finances/tests/test_views_extended.py::DeveloperCommissionStatusViewTest::test_get_status_success - django.urls.exceptions.NoReverseMatch: Reverse for 'developer-commission-status' not found. 'developer-commission-status' is not a valid view function or pattern name.
FAILED finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_create_credit_computes_status - django.urls.exceptions.NoReverseMatch: Reverse for 'client-credit-list' not found. 'client-credit-list' is not a valid view function or pattern name.
FAILED finances/tests/test_views_extended.py::ClientCreditAdminViewSetTest::test_update_credit_recomputes_status - django.urls.exceptions.NoReverseMatch: Reverse for 'client-credit-detail' not found. 'client-credit-detail' is not a valid view function or pattern name.
FAILED finances/tests/test_webhooks_extended.py::WompiWebhookServiceExtendedTest::test_process_token_update_success - django.core.exceptions.FieldError: EncryptedTextField 'exact' does not support lookups
FAILED finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_below_threshold - AttributeError: 'int' object has no attribute 'quantize'
FAILED finances/tests/test_services.py::DeveloperCommissionServiceTest::test_evaluate_payout_success - AttributeError: 'int' object has no attribute 'quantize'
FAILED finances/tests/test_services.py::DeveloperCommissionServiceTest::test_get_developer_debt - AttributeError: 'int' object has no attribute 'quantize'
================== 13 failed, 47 passed, 5 warnings in 8.48s ==================
